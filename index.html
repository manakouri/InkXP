<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>InkXP</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
      body {
        font-family: 'Poppins', sans-serif;
      }
    </style>
  <script type="importmap">
{
  "imports": {
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.0/",
    "react": "https://aistudiocdn.com/react@^19.2.0",
    "@google/genai": "https://aistudiocdn.com/@google/genai@^1.27.0"
  }
}
</script>
</head>
  <body class="bg-slate-50 text-slate-800">
    <div id="root"></div>

    <!-- Load React and ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    
    <!-- Load Firebase v9 Compat libraries -->
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
    
    <!-- Load Babel to transpile JSX in the browser -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Main Application Logic -->
    <script type="text/babel" data-type="module">
const { useState, useEffect, useCallback, useMemo, useRef } = React;

// GameState Constants
const GameState = Object.freeze({
    Home: 0,
    SoloSetup: 1,
    CreateGameSetup: 2,
    JoinGameSetup: 3,
    Lobby: 4,
    InGame: 5,
    Results: 6,
    TeacherDashboard: 7,
    SentenceBuilder: 8,
});

// Writing Category Constants
const WritingCategory = Object.freeze({
    Narrative: "Narrative",
    Persuasive: "Persuasive",
    Informative: "Informative",
    Editing: "Editing",
});

// Word & Prompt Constants
const NARRATIVE_PROMPTS = [
    { category: "Mystery & Discovery", text: "My fingers closed around a smooth, cool stone in the riverbed. It wasn't just any rock; it was pounamu, carved in a perfect spiral. As I lifted it out of the water, the stone grew strangely warm in my hand, and a deep, pulsing hum vibrated up my arm." },
    { category: "Mystery & Discovery", text: "The old bach at the end of the beach had been empty for years. But one night during a storm, I saw a light flickering in the window. I crept closer, wiped the salty spray from the glass, and peered inside. The room was empty, but sitting on the table was a single, steaming cup of tea." },
    { category: "Mystery & Discovery", text: "No one ever went into the old sports shed; Mr. Henderson kept it locked. But as I chased a stray netball, I saw the padlock was broken, lying on the grass. I nudged the door open with my foot, revealing a set of dusty stairs leading down into pure darkness." },
    { category: "Mystery & Discovery", text: "While helping Dad in the garden, my spade hit something hard. It wasn't a rock. I dug around it and pulled out a rusty metal box. It was locked, but there was a strange symbol carved on the lid, the same symbol I'd seen on the old statue in the park." },
    { category: "Mystery & Discovery", text: "I found an old key in the pocket of a second-hand coat. It didn't look like a normal house key. It was ornate and heavy. I wonder what it unlocks..." },
    { category: "Mystery & Discovery", text: "A message in a bottle washed up on the shore. The paper was old and the writing was faded, but I could just make out the words: 'Help me, I'm trapped on...'" },
    { category: "Adventure & Action", text: "'Stay on the track!' our teacher yelled. I just stepped off the path for a second to see a cool fungus. When I looked up, the rest of my school camp group had vanished. I called out, but the only reply was the call of a distant morepork, even though it was the middle of the day." },
    { category: "Adventure & Action", text: "The rugby ball soared high into the air. I leaped, my fingers stretching, ready for the winning catch. But just as I was about to grab it, a cheeky pīwakawaka swooped down and pecked the ball, sending it spinning in a completely different direction." },
    { category: "Adventure & Action", text: "The ground started to shake violently. I grabbed onto the nearest tree as a huge crack appeared in the earth, revealing a glowing cave below." },
    { category: "Adventure & Action", text: "I was kayaking down a calm river when the current suddenly picked up speed. I was being pulled towards a waterfall I didn't know existed!" },
    { category: "Fantasy & Sci-Fi", text: "My koro always told stories about the taniwha in the river. I thought he was just joking. But when I dropped my jandal in the water, a huge, scaly head with glowing red eyes rose from the rapids. It wasn't looking at my jandal; it was looking right at me." },
    { category: "Fantasy & Sci-Fi", text: "I was drawing in my notebook when my pencil started to move on its own. It wasn't just scribbling; it was drawing a map. A map that showed a secret door hidden somewhere inside my own school." },
    { category: "Fantasy & Sci-Fi", text: "One morning, I woke up and found that everything in my room was floating. My bed, my toys, even my cat was gently bumping against the ceiling, looking very confused. I tried to stand up, and my feet lifted right off the floor." },
    { category: "Fantasy & Sci-Fi", text: "I planted a strange seed I found in the forest. Overnight, it grew into a towering beanstalk that disappeared into the clouds." },
    { category: "Fantasy & Sci-Fi", text: "A small, friendly robot appeared at my door. It held up a sign that read: 'I am lost. Can you help me find my way back to the year 2099?'" },
    { category: "Real-Life & Emotional", text: "The moving van was packed. This was my last look at my old house. I waved goodbye to the pōhutukawa tree I used to climb and got in the car. As we drove past the dairy for the last time, I saw my best friend, Hemi, sprinting after the car, yelling and waving a small box I had never seen before." },
    { category: "Real-Life & Emotional", text: "It was my turn to speak in front of the whole school assembly. My knees were knocking together and my palms were sweaty. I took a deep breath, looked at my best friend in the crowd, and opened my mouth to..." },
    { category: "Real-Life & Emotional", text: "My first day at a new school. I didn't know anyone. As I walked into the playground, a ball rolled towards my feet..." },
    { category: "Real-Life & Emotional", text: "I worked for weeks to save up for a new bike. The day I finally bought it, I saw a kid from my class looking at it with sad eyes. Their old bike was broken and rusty." },
    { category: "Humour", text: "My lunchbox was missing. I looked everywhere. Finally, I heard a strange munching sound coming from the lost property bin. I peered inside and saw the school's pet goat, Gus, wearing my hat and happily eating my sandwiches." },
    { category: "Humour", text: "I tried to bake a cake for my mum's birthday, but I accidentally used salt instead of sugar. Her face when she took the first bite was priceless." },
    { category: "Humour", text: "Our class pet, a hamster named Nibbles, escaped from his cage. We found him in the library, sleeping on a tiny book he'd made into a bed." }
];
const ADJECTIVES = ['able', 'bad', 'best', 'better', 'big', 'black', 'blue', 'bright', 'busy', 'certain', 'clear', 'clean', 'cold', 'common', 'complete', 'cool', 'dark', 'dead', 'different', 'difficult', 'early', 'easy', 'empty', 'entire', 'fair', 'far', 'fast', 'few', 'final', 'fine', 'free', 'fresh', 'full', 'good', 'great', 'green', 'happy', 'hard', 'high', 'hot', 'huge', 'human', 'important', 'interesting', 'kind', 'large', 'last', 'late', 'light', 'little', 'long', 'low', 'main', 'major', 'many', 'mean', 'mental', 'modern', 'national', 'natural', 'near', 'new', 'next', 'nice', 'old', 'orange', 'only', 'open', 'other', 'past', 'personal', 'poor', 'possible', 'powerful', 'private', 'public', 'quick', 'quiet', 'real', 'recent', 'red', 'right', 'round', 'same', 'serious', 'short', 'similar', 'simple', 'single', 'small', 'soft', 'special', 'strong', 'sure', 'tall', 'true', 'warm', 'white', 'whole', 'wonderful', 'young', 'yellow', 'ancient', 'beautiful', 'brave', 'calm', 'charming', 'clever', 'crazy', 'creepy', 'cruel', 'curious', 'cute', 'dangerous', 'deep', 'delicious', 'delightful', 'dirty', 'dry', 'dull', 'eager', 'elegant', 'enormous', 'evil', 'expensive', 'famous', 'fancy', 'fantastic', 'fierce', 'filthy', 'fluffy', 'foolish', 'fragile', 'friendly', 'funny', 'gentle', 'giant', 'gorgeous', 'graceful', 'grumpy', 'handsome', 'healthy', 'helpful', 'horrible', 'innocent', 'jolly', 'juicy', 'lazy', 'lively', 'lonely', 'loud', 'lovely', 'lucky', 'magnificent', 'massive', 'mild', 'mysterious', 'nasty', 'naughty', 'nervous', 'noisy', 'perfect', 'plain', 'pleasant', 'precious', 'proud', 'purple', 'silly', 'sleepy', 'slimy', 'slow', 'sparkling', 'strange', 'sweet', 'tasty', 'terrible', 'thankful', 'thirsty', 'tiny', 'ugly', 'unusual', 'violet', 'wandering', 'weak', 'weary', 'wicked', 'wise', 'witty', 'worried', 'zany', 'absurd', 'active', 'adorable', 'adventurous', 'aggressive', 'agitated', 'alert', 'aloof', 'ambitious', 'annoyed', 'anxious', 'arrogant', 'ashamed', 'astonishing', 'attractive', 'average', 'awful', 'awkward', 'bashful', 'bewildered', 'billowing', 'bitter', 'bizarre', 'blazing', 'blissful', 'boiling', 'bouncy', 'breathtaking', 'breezy', 'broken', 'bumpy', 'burning', 'bustling', 'cautious', 'celestial', 'chaotic', 'cheerful', 'chilly', 'clumsy', 'colossal', 'combative', 'comfortable', 'concerned', 'condemned', 'confused', 'courageous', 'cowardly', 'cozy', 'crabby', 'crisp', 'cuddly', 'cultured', 'damp', 'dapper', 'daring', 'dashing', 'dauntless', 'dazzling', 'defeated', 'defiant', 'determined', 'disgusted', 'distinct', 'disturbed', 'dizzy', 'drab', 'drained', 'dreadful', 'dreary', 'dubious', 'eerie', 'elated', 'enchanting', 'encouraging', 'energetic', 'enraged', 'enthusiastic', 'envious', 'exasperated', 'excited', 'exhilarated', 'exuberant', 'fabulous', 'faint', 'faithful', 'fake', 'fanatical', 'fearless', 'feisty', 'ferocious', 'festive', 'fiery', 'filthy', 'flat', 'flimsy', 'fluffy', 'fluttering', 'foamy', 'forgetful', 'frantic', 'freezing', 'frightened', 'frosty', 'fuming', 'furious', 'fuzzy', 'gaudy', 'ghastly', 'gleaming', 'gleeful', 'glittering', 'glorious', 'glossy', 'golden', 'goofy', 'grand', 'greedy', 'grieving', 'grimy', 'grotesque', 'grubby', 'gusty', 'hairy', 'hazy', 'heavenly', 'hefty', 'helpless', 'hilarious', 'hissing', 'hollow', 'homely', 'hopeful', 'howling', 'hulking', 'humble', 'humorous', 'hungry', 'hurt', 'hushed', 'icy', 'ideal', 'ill', 'immense', 'imperfect', 'inquisitive', 'irate', 'itchy', 'jittery', 'joyful', 'joyous', 'jubilant', 'jumpy', 'keen', 'lame', 'lanky', 'lavish', 'lethal', 'listless', 'livid', 'loathsome', 'luminous', 'luscious', 'lush', 'luxurious', 'magical', 'majestic', 'marvelous', 'meek', 'melancholy', 'melodic', 'melted', 'merciful', 'messy', 'metallic', 'mighty', 'miniature', 'mischievous', 'miserable', 'misty', 'motionless', 'muddy', 'murky', 'mushy', 'muted', 'mythical', 'needy', 'numb', 'nutty', 'obedient', 'obnoxious', 'odd', 'ornate', 'outrageous', 'panicky', 'panoramic', 'parallel', 'parched', 'peaceful', 'peppery', 'perky', 'perplexed', 'petite', 'phony', 'piercing', 'pink', 'placid', 'plump', 'pointless', 'polite', 'posh', 'prickly', 'puzzled', 'quaint', 'quivering', 'radiant', 'ragged', 'rambunctious', 'raspy', 'ratty', 'reassured', 'rejoicing', 'relaxed', 'relieved', 'remarkable', 'remorseful', 'repulsive', 'resonant', 'restless', 'restrained', 'rich', 'ripe', 'robust', 'rosy', 'rotten', 'rough', 'rowdy', 'rustic', 'sad', 'salty', 'sarcastic', 'sassy', 'satisfied', 'savory', 'scaly', 'scarce', 'scared', 'scary', 'scattered', 'scrawny', 'screeching', 'scruffy', 'selfish', 'serene', 'shaggy', 'shaky', 'shallow', 'sharp', 'shiny', 'shivering', 'shocked', 'shrill', 'shy', 'silent', 'silky', 'skinny', 'smoggy', 'smoky', 'smooth', 'smug', 'soggy', 'solid', 'somber', 'soothing', 'sore', 'sour', 'sparkling', 'spicy', 'spiky', 'splendid', 'spooky', 'spotless', 'spotty', 'square', 'squeaky', 'stale', 'statuesque', 'steaming', 'sticky', 'stiff', 'stingy', 'stormy', 'stout', 'straight', 'striped', 'stuffy', 'stunning', 'subtle', 'successful', 'succulent', 'sulky', 'sunny', 'superb', 'superficial', 'superior', 'swanky', 'sweltering', 'swift', 'talented', 'tame', 'tan', 'tart', 'taut', 'tearful', 'tedious', 'teeny', 'tender', 'tense', 'tepid', 'testy', 'thin', 'thoughtful', 'thoughtless', 'threatening', 'thrifty', 'thrilled', 'thundering', 'tight', 'timely', 'timid', 'torpid', 'tough', 'towering', 'tranquil', 'tremendous', 'tricky', 'troubled', 'tumultuous', 'turbulent', 'ubiquitous', 'unarmed', 'unbecoming', 'unbiased', 'uncommon', 'uncovered', 'uneven', 'uninterested', 'unique', 'unkempt', 'unknown', 'unusual', 'unwieldy', 'upbeat', 'upset', 'uptight', 'vast', 'vexed', 'vibrant', 'vicious', 'victorious', 'virtuous', 'vivacious', 'vivid', 'voiceless', 'volatile', 'voracious', 'wacky', 'watchful', 'watery', 'wavy', 'wealthy', 'whimsical', 'whopping', 'wild', 'windy', 'wiry', 'wonderful', 'wooden', 'worn', 'worthless', 'wrathful', 'wretched', 'wrong', 'yummy', 'zealous'];
const SENSORY_WORDS = { sight: ['bleak', 'blurred', 'bright', 'clear', 'colourful', 'crooked', 'dark', 'dazzling', 'dim', 'drab', 'dusky', 'faded', 'fiery', 'glistening', 'gloomy', 'glowing', 'hazy', 'murky', 'shimmering', 'sparkling', 'shadowy', 'vibrant', 'golden', 'silvery', 'transparent', 'glossy', 'matte', 'streaked', 'checkered', 'dotted', 'striped', 'blazing', 'blurry', 'brilliant', 'cloudy', 'crystalline', 'ebony', 'emerald', 'flashing', 'flickering', 'fluorescent', 'foggy', 'gaudy', 'ghostly', 'gleaming', 'glinting', 'glittering', 'grainy', 'grimy', 'illuminated', 'in-focus', 'in-shadow', 'incandescent', 'iridescent', 'ivory', 'jet-black', 'luminous', 'lustrous', 'misty', 'monochromatic', 'mottled', 'muddy', 'opalescent', 'opaque', 'out-of-focus', 'pale', 'patchy', 'pearly', 'phosphorescent', 'pitch-black', 'polished', 'prismatic', 'radiant', 'reflective', 'rosy', 'ruby', 'rusty', 'sapphire', 'saturated', 'scarlet', 'sepia', 'smoky', 'smudged', 'sooty', 'speckled', 'spotless', 'spotted', 'starry', 'steamy', 'sun-bleached', 'sun-drenched', 'sun-kissed', 'swirling', 'tarnished', 'textured', 'translucent', 'variegated', 'velvety-black', 'vivid', 'washed-out', 'watery', 'wavy', 'waxen', 'weather-beaten', 'wispy', 'worn'], sound: ['banging', 'blaring', 'buzzing', 'chiming', 'clanging', 'crashing', 'creaking', 'deafening', 'echoing', 'fizzing', 'grinding', 'gurgling', 'hissing', 'howling', 'humming', 'hushed', 'piercing', 'rasping', 'rattling', 'ringing', 'roaring', 'rumbling', 'rustling', 'screeching', 'sizzling', 'slamming', 'snapping', 'splashing', 'thudding', 'thumping', 'tinkling', 'wailing', 'whimpering', 'whirring', 'whispering', 'melodious', 'shrill', 'silent', 'thundering', 'babbling', 'barking', 'bawling', 'baying', 'bellowing', 'bleating', 'booming', 'cackling', 'chattering', 'cheeping', 'chirping', 'clacking', 'clicking', 'clinking', 'clucking', 'cooing', 'coughing', 'croaking', 'crowing', 'crying', 'droning', 'drumming', 'exploding', 'flapping', 'footsteps', 'gasping', 'giggling', 'groaning', 'growling', 'grunting', 'guffawing', 'hiccuping', 'hollering', 'hooting', 'jingling', 'knocking', 'laughing', 'lapping', 'lilting', 'moaning', 'murmuring', 'muttering', 'neighing', 'panting', 'pattering', 'pealing', 'piping', 'popping', 'purring', 'quacking', 'rapping', 'reverberating', 'rippling', 'rustling', 'scratching', 'screaming', 'shouting', 'shrieking', 'sighing', 'sloshing', 'smacking', 'snarling', 'sniffling', 'snoozing', 'snoring', 'snorting', 'sobbing', 'splattering', 'splintering', 'squawking', 'squeaking', 'squealing', 'squishing', 'stammering', 'stomping', 'swishing', 'tapping', 'thwacking', 'ticking', 'tolling', 'tooting', 'trilling', 'tweeting', 'ululating', 'vibrating', 'warbling', 'wheezing', 'whining', 'whistling', 'whooshing', 'yelling', 'yelping', 'yipping', 'yodeling', 'zap', 'zing', 'zip', 'zoom', 'bam', 'bang', 'bash', 'beep', 'biff', 'boing', 'boink', 'bonk', 'bong', 'boom', 'boosh', 'bump', 'burp', 'clank', 'clap', 'clatter', 'clink', 'clomp', 'clunk', 'crack', 'crackle', 'crunch', 'ding', 'dong', 'drip', 'fizz', 'flump', 'glug', 'gong', 'honk', 'jangle', 'jingle', 'kerplunk', 'klang', 'klunk', 'oof', 'ouch', 'plink', 'plop', 'plunk', 'pow', 'puff', 'pitter-patter', 'ring', 'rip', 'slam', 'slap', 'smash', 'snip', 'splash', 'splat', 'squelch', 'squish', 'swat', 'swoosh', 'thud', 'thump', 'thwack', 'tick-tock', 'twang', 'vroom', 'whack', 'wham', 'whomp', 'whump', 'zlonk'], smell: ['acrid', 'aromatic', 'burnt', 'damp', 'earthy', 'fishy', 'floral', 'fragrant', 'fresh', 'meaty', 'mouldy', 'musky', 'musty', 'perfumed', 'pungent', 'putrid', 'rancid', 'reeking', 'rotten', 'salty', 'smoky', 'sour', 'spicy', 'stale', 'sweet', 'tangy', 'woody', 'pine', 'scented', 'odourless', 'acrid', 'antiseptic', 'balmy', 'briny', 'buttery', 'camphoric', 'caramelized', 'caustic', 'charred', 'chemical', 'chlorinated', 'chocolaty', 'cigar', 'cinnamon', 'citrus', 'clean', 'cloying', 'coastal', 'coffee', 'cologne', 'cool', 'creamy', 'crisp', 'curried', 'decaying', 'delectable', 'delicate', 'deodorized', 'dilly', 'disgusting', 'doughey', 'dry', 'dusty', 'eggy', 'ethereal', 'faint', 'fecal', 'fermented', 'feverish', 'fetid', 'fiery', 'floury', 'flowery', 'foul', 'foxy', 'fruity', 'fumes', 'fumy', 'fungal', 'gamy', 'garlicky', 'gaseous', 'gingery', 'greasy', 'grassy', 'heady', 'herbal', 'honeyed', 'hot', 'humid', 'incense', 'industrial', 'intoxicating', 'lactic', 'leathery', 'lemony', 'light', 'lilac', 'loamy', 'malty', 'marine', 'medicinal', 'mellow', 'mild', 'mildewed', 'milky', 'minty', 'moist', 'mossy', 'mouth-watering', 'muddy', 'musky', 'nauseating', 'new-car', 'nutty', 'oaky', 'oceanic', 'oily', 'old-book', 'oniony', 'overpowering', 'ozone', 'peaty', 'peppery', 'petrol', 'piney', 'piquant', 'plank', 'plastic', 'powdery', 'prickly', 'protein', 'pulpy', 'putrid', 'quince', 'rain-soaked', 'rancid', 'rank', 'raw', 'refreshing', 'resinous', 'rich', 'ripe', 'roasted', 'robust', 'rosy', 'rubbery', 'saccharine', 'saline', 'sanitized', 'savoury', 'septic', 'sharp', 'sickly', 'skunky', 'soapy', 'soothing', 'soupy', 'sour-milk', 'soapy', 'soothing', 'soupy', 'sour-milk', 'soya', 'spoiled', 'stagnant', 'steamy', 'sterile', 'stinging', 'strong', 'subtle', 'sugary', 'sulfuric', 'sweaty', 'syrupy', 'tainted', 'tarry', 'terpenic', 'toasted', 'tobacco', 'unscented', 'vanilla', 'vegetal', 'vile', 'vinegary', 'volcanic', 'warm', 'waxy', 'wet-dog', 'yeasty', 'zesty'], touch: ['blistering', 'bristly', 'bubbling', 'chilled', 'clammy', 'coarse', 'cool', 'damp', 'freezing', 'frigid', 'frosty', 'fuzzy', 'gooey', 'gritty', 'hairy', 'icy', 'jagged', 'lukewarm', 'numb', 'prickly', 'pulsing', 'rough', 'scalding', 'silky', 'slimy', 'slippery', 'smooth', 'soaked', 'sodden', 'spiky', 'spongy', 'steaming', 'sticky', 'stinging', 'tepid', 'thorny', 'throbbing', 'velvety', 'warm', 'waxy', 'wet', 'woolly', 'sharp', 'blunt', 'feathery', 'abrasive', 'airy', 'alive', 'barbed', 'bending', 'biting', 'bloated', 'boiling', 'bony', 'bouncy', 'bumpy', 'burning', 'bushy', 'buttery', 'calloused', 'chalky', 'cinder', 'clay-like', 'close', 'cloud-like', 'clumpy', 'cluttered', 'compact', 'congested', 'corduroy', 'cottony', 'crawling', 'crisp', 'cushioned', 'cushy', 'delicate', 'dense', 'doughy', 'downy', 'drenched', 'dry', 'dusty', 'elastic', 'embossed', 'engraved', 'etched', 'even', 'fibrous', 'fiery', 'fine-grained', 'firm', 'flat', 'fleshy', 'flimsy', 'fluffy', 'fluid', 'flushed', 'foamy', 'foggy', 'folded', 'fragile', 'furry', 'gelatinous', 'glassy', 'glutinous', 'gnarled', 'grainy', 'greasy', 'gummy', 'hard', 'hollow', 'hot', 'humid', 'impenetrable', 'indelible', 'inflated', 'in-the-way', 'ironed', 'irritating', 'ivory', 'kinky', 'knitted', 'knobby', 'knotted', 'lacy', 'laminated', 'lathery', 'leathery', 'level', 'light', 'limp', 'lined', 'long-haired', 'loose', 'lumpy', 'malleable', 'matted', 'metallic', 'moist', 'mossy', 'muddy', 'mushy', 'oily', 'open', 'padded', 'papery', 'parched', 'pasted', 'pasty', 'pebbly', 'penetrating', 'plastic', 'pliable', 'plump', 'plush', 'polished', 'puckered', 'puffy', 'pulpy', 'pungent', 'quilted', 'raised', 'raspy', 'raw', 'resilient', 'ribbed', 'rigid', 'rocky', 'rubbery', 'rugged', 'rumpled', 'rusty', 'sandy', 'satin', 'scabrous', 'scaly', 'scorching', 'scraped', 'scratched', 'scruffy', 'sculpted', 'searing', 'shaggy', 'shaky', 'shallow', 'shivering', 'short-haired', 'silken', 'sizzling', 'slick', 'slushy', 'soapy', 'soft', 'soggy', 'solid', 'soothing', 'springy', 'starched', 'stiff', 'stony', 'straw-like', 'stretchy', 'stringy', 'structured', 'stuffy', 'sturdy', 'suede', 'sugary', 'sunken', 'supple', 'taut', 'tender', 'tense', 'thick', 'thin', 'tickling', 'tight', 'tingling', 'tough', 'uneven', 'unstable', 'upholstered', 'vibrating', 'viscous', 'yielding'], taste: ['acidic', 'bitter', 'bland', 'briny', 'chalky', 'cheesy', 'citrusy', 'creamy', 'crisp', 'crumbly', 'fiery', 'flavourful', 'fruity', 'gingery', 'hearty', 'honeyed', 'hot', 'juicy', 'meaty', 'minty', 'overripe', 'peppery', 'pickled', 'rich', 'ripe', 'roasted', 'salty', 'savoury', 'sharp', 'smoky', 'sour', 'spicy', 'stale', 'sugary', 'sweet', 'tangy', 'tart', 'watery', 'zesty', 'delicious', 'disgusting', 'alkaline', 'ambrosial', 'appetizing', 'astringent', 'buttery', 'caramelized', 'caustic', 'charred', 'chocolaty', 'cinnamony', 'cloying', 'coarse', 'cool', 'curried', 'dank', 'doughy', 'dry', 'dulcet', 'eggy', 'fermented', 'foul', 'fresh', 'full-bodied', 'gamy', 'garlicky', 'gelatinous', 'gingery', 'glutinous', 'grainy', 'greasy', 'gritty', 'harsh', 'heady', 'herbal', 'infused', 'insipid', 'intense', 'leathery', 'lemony', 'light', 'mellow', 'metallic', 'mild', 'milky', 'moist', 'molten', 'mouth-watering', 'nectarous', 'nutty', 'oily', 'palatable', 'piquant', 'plastic', 'powdery', 'pulpy', 'pungent', 'raw', 'refreshing', 'resinous', 'robust', 'rubbery', 'saccharine', 'saline', 'scrumptious', 'seasoned', 'sharp', 'sickly', 'soapy', 'soothing', 'sour-milk', 'strong', 'succulent', 'syrupy', 'tainted', 'tasteless', 'thick', 'thin', 'toasted', 'tough', 'unappetizing', 'unflavored', 'unripe', 'vanilla', 'velvety', 'vinegary', 'weak', 'yeasty', 'yummy'] };
const ALL_SENSORY_WORDS = Object.values(SENSORY_WORDS).flat();
const CONJUNCTIONS = ['for', 'and', 'nor', 'but', 'or', 'yet', 'so', 'after', 'although', 'as', 'as if', 'as long as', 'as much as', 'as soon as', 'as though', 'because', 'before', 'by the time', 'even if', 'even though', 'if', 'in case', 'in order that', 'lest', 'now that', 'once', 'only if', 'provided that', 'since', 'so that', 'than', 'that', 'though', 'till', 'unless', 'until', 'when', 'whenever', 'where', 'whereas', 'wherever', 'whether', 'while', 'both...and', 'either...or', 'neither...nor', 'not only...but also', 'whether...or'];
const TRANSITIONAL_WORDS = ['after', 'afterward', 'all of a sudden', 'as soon as', 'at first', 'at last', 'at that moment', 'before', 'by the time', 'concurrently', 'earlier', 'eventually', 'finally', 'first', 'following', 'from that point on', 'immediately', 'in the beginning', 'in the meantime', 'instantly', 'just then', 'later', 'later on', 'meanwhile', 'next', 'not long after', 'now', 'once', 'presently', 'second', 'shortly after', 'simultaneously', 'since', 'soon', 'suddenly', 'then', 'third', 'until', 'when', 'while', 'above all', 'additionally', 'also', 'and', 'another', 'as well', 'besides', 'especially', 'furthermore', 'in addition', 'in fact', 'indeed', 'more importantly', 'moreover', 'not only... but also', 'of course', 'specifically', 'then again', 'too', 'truly', 'although', 'but', 'despite', 'even so', 'even though', 'however', 'in contrast', 'instead', 'nevertheless', 'nonetheless', 'on the contrary', 'on the other hand', 'otherwise', 'still', 'though', 'unlike', 'whereas', 'yet', 'accordingly', 'as a result', 'because', 'consequently', 'due to', 'for this reason', 'hence', 'so', 'therefore', 'thus', 'above', 'across', 'around', 'behind', 'below', 'beside', 'beyond', 'here', 'nearby', 'opposite', 'over', 'under', 'for example', 'for instance', 'in other words', 'that is', 'to illustrate', 'in conclusion', 'in summary', 'to sum up'];
const SENTENCE_ROOTS = [
    { root: "The cat sat.", verb: "sat" },
    { root: "The dog barked.", verb: "barked" },
    { root: "The bird flew.", verb: "flew" },
    { root: "The sun shone.", verb: "shone" },
    { root: "The car moved.", verb: "moved" },
    { root: "The girl ran.", verb: "ran" },
    { root: "The boy jumped.", verb: "jumped" },
    { root: "The river flowed.", verb: "flowed" },
    { root: "The tree stood.", verb: "stood" },
    { root: "The baby cried.", verb: "cried" },
    { root: "The door opened.", verb: "opened" },
    { root: "The bell rang.", verb: "rang" },
    { root: "The horse galloped.", verb: "galloped" },
    { root: "The man walked.", verb: "walked" },
    { root: "The flower grew.", verb: "grew" },
    { root: "The phone rang.", verb: "rang" },
    { root: "The ball bounced.", verb: "bounced" },
    { root: "The star twinkled.", verb: "twinkled" },
    { root: "The train arrived.", verb: "arrived" },
    { root: "The child laughed.", verb: "laughed" },
    { root: "The wind blew.", verb: "blew" }
];
const KETE_WORDS = {
    'Describing Words': ['ancient', 'big', 'brave', 'bright', 'calm', 'colourful', 'creepy', 'curious', 'dangerous', 'dark', 'delicious', 'enormous', 'fluffy', 'friendly', 'gentle', 'giant', 'grumpy', 'huge', 'lonely', 'loud', 'massive', 'mysterious', 'quiet', 'shaggy', 'small', 'sparkling', 'strange', 'sunny', 'sweet', 'tiny', 'weary'],
    'Action Words': ['ambled', 'crawled', 'crept', 'cried', 'danced', 'darted', 'dashed', 'drifted', 'exploded', 'floated', 'flew', 'glided', 'hopped', 'hurried', 'leaped', 'raced', 'ran', 'roared', 'rushed', 'scampered', 'screamed', 'shouted', 'skipped', 'soared', 'sprinted', 'stormed', 'strolled', 'wandered', 'whispered', 'yelled', 'zoomed'],
    'How/When/Where Phrases': ['across the field', 'after school', 'all of a sudden', 'at the park', 'behind the door', 'down the street', 'early in the morning', 'in the afternoon', 'inside the box', 'late at night', 'like a rocket', 'near the river', 'on the weekend', 'over the fence', 'quickly', 'quietly', 'slowly', 'suddenly', 'through the forest', 'under the bed', 'with excitement'],
    'Sensory Details': ['a delicious smell', 'a loud crash', 'a sharp sting', 'a sweet taste', 'bright colours', 'cold wind', 'crunchy leaves', 'fluffy clouds', 'freezing water', 'hot sun', 'rough bark', 'silky smooth', 'the sound of waves', 'warm sand', 'with a high-pitched yip']
};

// Gemini API Service
const callApi = async (task, payload) => {
    const response = await fetch('/api/gemini', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ task, payload }),
    });

    if (!response.ok) {
        const errorBody = await response.json().catch(() => ({ error: `API call failed with status ${response.status}` }));
        throw new Error(errorBody.error || `API call failed with status ${response.status}`);
    }

    return response.json();
};

const generateImageForPrompt = async (promptText) => {
    try {
        const result = await callApi('generateImage', { promptText });
        return result.imageUrl;
    } catch (error) {
        console.error("Error generating image:", error);
        return null;
    }
};

const getSentenceFeedback = async (rootSentence, userSentence) => {
    try {
        return await callApi('getSentenceFeedback', { rootSentence, userSentence });
    } catch (error) {
        console.error("Error getting sentence feedback:", error);
        return { qualityScore: 1.0, feedback: "Great job trying something new!" };
    }
};

// Firebase Service
const firebaseConfig = {
  apiKey: "AIzaSyAVUseBH0axB3fVUOg7rgALJBvq4N4N-1M",
  authDomain: "inkxp-569a6.firebaseapp.com",
  projectId: "inkxp-569a6",
  storageBucket: "inkxp-569a6.firebasestorage.app",
  messagingSenderId: "578474339685",
  appId: "1:578474339685:web:9f7b26c637beea31c0458c"
};
const app = firebase.initializeApp(firebaseConfig);
const db = firebase.firestore(app);
const auth = firebase.auth(app);
const googleProvider = new firebase.auth.GoogleAuthProvider();

const onAuthChange = (callback) => auth.onAuthStateChanged(callback);
const signInWithGoogle = () => auth.signInWithPopup(googleProvider);
const signOutUser = () => auth.signOut();

const generateGameCode = () => Math.random().toString(36).substring(2, 8).toUpperCase();

const createGame = async (hostId, prompt, criteria, duration, teacherId, promptImageUrl) => {
    const gameCode = generateGameCode();
    const gameRef = db.collection('games').doc(gameCode);
    const gameData = {
        hostId, prompt, criteria, duration, teacherId, promptImageUrl,
        status: 'waiting',
        players: {},
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
    };
    await gameRef.set(gameData);
    return gameCode;
};

const joinGame = async (gameCode, playerId, playerNickname) => {
    const gameRef = db.collection('games').doc(gameCode);
    const gameSnap = await gameRef.get();
    if (!gameSnap.exists) throw new Error("Game not found!");
    const gameData = gameSnap.data();
    if (gameData.status === 'finished') throw new Error("This game has already finished.");
    await gameRef.update({ [`players.${playerId}`]: { nickname: playerNickname, story: { title: '', text: '' }, analysis: null } });
    return gameData;
};

const getGameStream = (gameCode, callback) => db.collection('games').doc(gameCode).onSnapshot((doc) => callback(doc.data()));

const getGamesForTeacher = (teacherId, callback) => {
  const q = db.collection("games")
      .where("teacherId", "==", teacherId)
      .orderBy("createdAt", "desc");
  return q.onSnapshot((querySnapshot) => {
      const games = [];
      querySnapshot.forEach((doc) => {
          games.push({ id: doc.id, ...doc.data() });
      });
      callback(games);
  });
};

const startGame = async (gameCode) => await db.collection('games').doc(gameCode).update({
  status: 'in-progress',
  startTime: firebase.firestore.FieldValue.serverTimestamp()
});

const submitResult = async (gameCode, playerId, story, analysis) => {
  const gameRef = db.collection('games').doc(gameCode);
  await gameRef.update({
      [`players.${playerId}.story`]: story,
      [`players.${playerId}.analysis`]: analysis,
  });
};

const updatePlayerAnalysis = async (gameCode, playerId, analysis) => {
  const gameRef = db.collection('games').doc(gameCode);
  await gameRef.update({
      [`players.${playerId}.analysis`]: analysis,
  });
};

const finishGame = async (gameCode) => {
  await db.collection('games').doc(gameCode).update({ status: 'finished' });
}

// Scoring Service
const countWords = (text, words) => {
    if (!text) return 0;
    const lowerText = text.toLowerCase();
    let count = 0;
    for (const word of words) {
        const regex = new RegExp(`\\b${word.toLowerCase().replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&')}\\b`, 'g');
        const matches = lowerText.match(regex);
        if (matches) {
            count += matches.length;
        }
    }
    return count;
};

const ALL_SCORING_CRITERIA = [
    {
        id: 'dialogue', name: 'Dialogue', type: 'always',
        description: 'Using dialogue with correct punctuation (e.g., "Hello," she said.)', points: 1500,
        check: (text) => {
             if (!text) return 0;
            const dialoguePatterns = [
                /"[^"]*," \w+ (said|asked|yelled|whispered|exclaimed|snapped|replied|muttered)\./i,
                /\w+ (said|asked|yelled|whispered|exclaimed|snapped|replied|muttered), "[^"]*[\.?!]"/i,
                /"[^"]*," \w+ (said|asked|yelled|whispered|exclaimed|snapped|replied|muttered), "[^"]*[\.?!]"/i,
                /"[^"]+[\.?!]"/
            ];
            return dialoguePatterns.some(pattern => pattern.test(text)) ? 1 : 0;
        }
    },
    {
        id: 'paragraphs', name: 'Paragraphs', type: 'always',
        description: 'Leaving a blank line to start a new paragraph', points: 1500,
        check: (text) => {
            if (!text) return 0;
            return (/(?:\r\n|\n){2,}/.test(text.trim())) ? 1 : 0;
        }
    },
    {
        id: 'sentence', name: 'Punctuated Sentences', type: 'always',
        description: 'For each correctly punctuated sentence (. ! ?) with a capital letter', points: 100,
        check: (text) => {
            if (!text) return 0;
            const sentences = text.split(/[.!?]/).filter(s => s.trim().length > 0);
            return sentences.filter(s => s.trim().match(/^[A-Z]/)).length;
        }
    },
    {
        id: 'complexSentence', name: 'Complex Sentences', type: 'random',
        description: 'For each complex sentence using a joining word', points: 100,
        check: (text) => countWords(text, CONJUNCTIONS)
    },
    {
        id: 'simile', name: 'Similes', type: 'random',
        description: 'For each simile used (e.g., "like a lion" or "as fast as a cheetah")', points: 100,
        check: (text) => {
             if (!text) return 0;
            const likeCount = (text.match(/\b\w+\s+like\s+\w+\b/gi) || []).length;
            const asAsCount = (text.match(/\bas\s+\w+\s+as\s+(a|an)\s+\w+\b/gi) || []).length;
            return likeCount + asAsCount;
        }
    },
    {
        id: 'transitional', name: 'Transitional Words', type: 'random',
        description: 'For each transitional word or phrase used to link ideas', points: 100,
        check: (text) => countWords(text, TRANSITIONAL_WORDS)
    },
    {
        id: 'sensory', name: 'Sensory Detail', type: 'random',
        description: 'For each sensory detail used (sight, sound, smell, touch, taste)', points: 100,
        check: (text) => countWords(text, ALL_SENSORY_WORDS)
    },
    {
        id: 'adjectives', name: 'Adjectives', type: 'random',
        description: `For each adjective used`, points: 100,
        check: (text) => countWords(text, ADJECTIVES)
    }
];

const analyzeScore = (text, criteria) => {
    let totalScore = 0;
    const breakdown = criteria.map(criterion => {
        const count = criterion.check(text);
        const score = count * criterion.points;
        totalScore += score;
        return { id: criterion.id, name: criterion.name, count, score };
    });
    if (breakdown.length === 0) {
        return { totalScore: 0, breakdown: [], highestScoring: { name: 'N/A', score: 0}, lowestScoring: { name: 'N/A', score: 0}};
    }
    const sortedByScore = [...breakdown].sort((a, b) => b.score - a.score);
    const highestScoring = { name: sortedByScore[0].name, score: sortedByScore[0].score };
    const lowestScoring = { name: sortedByScore[sortedByScore.length - 1].name, score: sortedByScore[sortedByScore.length - 1].score };
    return { totalScore, breakdown, highestScoring, lowestScoring };
};

// PDF Utility
const downloadPDF = (nickname, story, prompt) => {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    
    const title = story?.title || 'Untitled Story';
    const text = story?.text || 'No text submitted.';

    doc.setFontSize(22);
    doc.setFont('helvetica', 'bold');
    doc.text(title, 105, 20, { align: 'center' });

    doc.setFontSize(14);
    doc.setFont('helvetica', 'normal');
    doc.text(`By: ${nickname}`, 105, 30, { align: 'center' });
    
    doc.setFontSize(10);
    doc.setTextColor(150);
    doc.text(`Prompt: ${prompt.text}`, 10, 45, { maxWidth: 190 });

    doc.setLineWidth(0.5);
    doc.line(10, 55, 200, 55);

    doc.setFontSize(12);
    doc.setTextColor(0);
    const storyLines = doc.splitTextToSize(text, 190);
    doc.text(storyLines, 10, 65);

    doc.save(`InkXP_Story_${nickname.replace(/\s/g, '_')}.pdf`);
};

// React Components
const LoadingSpinner = () => <div className="w-8 h-8 border-4 border-sky-200 border-t-sky-600 rounded-full animate-spin"></div>;

const Timer = ({ startTime, duration, onTimeUp }) => {
    const [secondsLeft, setSecondsLeft] = useState(Number(duration));
    const onTimeUpRef = useRef(onTimeUp);
    onTimeUpRef.current = onTimeUp;

    useEffect(() => {
        if (!startTime) {
            setSecondsLeft(Number(duration));
            return;
        }

        const intervalId = setInterval(() => {
            const gameStartTime = (startTime.toDate ? startTime.toDate() : startTime).getTime();
            const elapsed = Math.floor((Date.now() - gameStartTime) / 1000);
            const remaining = Number(duration) - elapsed;

            if (remaining <= 0) {
                setSecondsLeft(0);
                onTimeUpRef.current();
                clearInterval(intervalId);
            } else {
                setSecondsLeft(remaining);
            }
        }, 1000);

        return () => clearInterval(intervalId);
    }, [startTime, duration]);

    const minutes = Math.floor(secondsLeft / 60);
    const remainingSeconds = secondsLeft % 60;
    return <div className="text-5xl font-bold tracking-tighter"><span>{minutes.toString().padStart(2, '0')}</span><span className="animate-pulse">:</span><span>{remainingSeconds.toString().padStart(2, '0')}</span></div>;
};

const Button = ({ children, className = '', variant = 'primary', size = 'medium', ...props }) => {
    const baseStyles = 'font-bold rounded-lg focus:outline-none focus:ring-2 focus:ring-offset-2 transition-transform duration-150 ease-in-out disabled:opacity-50 disabled:cursor-not-allowed transform active:scale-95';
    const variantStyles = { primary: 'bg-sky-600 text-white hover:bg-sky-700 focus:ring-sky-500 disabled:hover:bg-sky-600', secondary: 'bg-slate-200 text-slate-800 hover:bg-slate-300 focus:ring-slate-400 disabled:hover:bg-slate-200' };
    const sizeStyles = { small: 'py-1.5 px-3 text-sm', medium: 'py-2 px-5 text-base', large: 'py-3 px-8 text-lg' };
    return <button className={`${baseStyles} ${variantStyles[variant]} ${sizeStyles[size]} ${className}`} {...props}>{children}</button>;
};

const NicknamePrompt = ({ onNicknameSubmit }) => {
    const [nickname, setNickname] = useState('');
    const handleSubmit = (e) => { e.preventDefault(); if (nickname.trim()) { onNicknameSubmit(nickname.trim()); } };
    return (
        <div className="fixed inset-0 bg-slate-900/80 backdrop-blur-sm flex items-center justify-center z-50">
            <div className="bg-white p-8 rounded-xl shadow-2xl w-full max-w-sm text-center">
                <h2 className="text-2xl font-bold text-slate-800 mb-4">Enter Player Name(s)</h2>
                <p className="text-slate-600 mb-6">If playing together on this device, separate names with a comma (e.g., Rachel F, Sam C).</p>
                <form onSubmit={handleSubmit}>
                    <input type="text" value={nickname} onChange={(e) => setNickname(e.target.value)} className="w-full p-3 border border-slate-300 rounded-lg shadow-inner focus:ring-2 focus:ring-sky-500 focus:border-sky-500 transition-shadow duration-200 text-lg text-center" placeholder="e.g. Rachel F, Sam C" maxLength={50} required />
                    <Button type="submit" size="large" className="mt-6 w-full">Let's Go!</Button>
                </form>
            </div>
        </div>
    );
};

const Tooltip = ({ children, text }) => (
    <div className="relative flex items-center group">
        {children}
        <div className="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 w-max max-w-xs p-2 text-sm text-white bg-slate-800 rounded-md shadow-lg opacity-0 group-hover:opacity-100 transition-opacity duration-300 z-10 pointer-events-none">
            {text}
            <div className="absolute top-full left-1/2 -translate-x-1/2 w-0 h-0 border-x-4 border-x-transparent border-t-4 border-t-slate-800"></div>
        </div>
    </div>
);

const ResultsScreen = ({ gameData, playerId, onPlayAgain, onGoHome, onRetryPrompt, soloHighScore }) => {
  const myPlayer = gameData.players[playerId];
  const myAnalysis = myPlayer?.analysis;
  const myFinalStory = myPlayer?.story;
  const isSolo = onRetryPrompt !== undefined;

  const sortedPlayers = Object.entries(gameData.players)
    .map(([id, data]) => ({ id, ...data, totalScore: data.analysis?.totalScore || 0 }))
    .sort((a, b) => b.totalScore - a.totalScore);

  return (
      <div className="flex flex-col items-center">
          <h2 className="text-3xl font-bold text-emerald-600 mb-2">Time's Up!</h2>
          <p className="text-slate-600 mb-6">Fantastic effort! Here are the final scores.</p>
          <div className="w-full grid grid-cols-1 lg:grid-cols-3 gap-8">
              <div className="lg:col-span-2 bg-white p-6 rounded-lg shadow-md border border-slate-200">
                  <h3 className="text-xl font-bold mb-2 text-slate-800">{myFinalStory?.title || "Untitled Story"}</h3>
                  <p className="text-sm font-semibold text-sky-600 mb-4">{gameData.prompt.text}</p>
                  <div className="prose max-w-none text-slate-700 whitespace-pre-wrap bg-slate-50 p-4 rounded-md">{myFinalStory?.text || "You didn't write anything this time. Try again!"}</div>
              </div>
              <div className="lg:col-span-1 space-y-6">
                  {isSolo ? (
                     <div className="bg-white p-6 rounded-lg shadow-md border border-slate-200 text-center">
                         <h3 className="text-lg font-bold text-slate-500 uppercase tracking-wider mb-3">High Score</h3>
                         <p className="text-4xl font-bold text-amber-500">{soloHighScore.toLocaleString()}</p>
                     </div>
                  ) : (
                      <div className="bg-white p-6 rounded-lg shadow-md border border-slate-200">
                           <h3 className="text-lg font-bold text-slate-500 uppercase tracking-wider mb-3">Leaderboard</h3>
                           <ol className="space-y-2">
                            {sortedPlayers.map((player, index) => (
                               <li key={player.id} className={`p-2 rounded-md flex justify-between items-center ${player.id === playerId ? 'bg-sky-100' : 'bg-slate-50'}`}>
                                 <span className="font-semibold text-slate-700">{index + 1}. {player.nickname}</span>
                                 <span className="font-bold text-sky-600">{player.totalScore.toLocaleString()}</span>
                               </li>
                            ))}
                           </ol>
                      </div>
                  )}
                  {myAnalysis && (
                      <div className="bg-white p-6 rounded-lg shadow-md border border-slate-200">
                          <h3 className="text-xl font-bold mb-4 text-slate-800">Your Score Breakdown</h3>
                           <ul className="space-y-2">
                              {myAnalysis.breakdown.map((item) => {
                                  const criterion = ALL_SCORING_CRITERIA.find(c => c.id === item.id);
                                  return (
                                    <li key={item.id} className="flex justify-between items-center text-sm p-2 bg-slate-50 rounded-md">
                                        <Tooltip text={criterion?.description || 'No description available.'}>
                                            <div className="flex items-center gap-1.5 cursor-help">
                                                <span className="text-slate-700">{item.name} ({item.count})</span>
                                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className="w-4 h-4 text-slate-400"><path strokeLinecap="round" strokeLinejoin="round" d="m11.25 11.25.041-.02a.75.75 0 0 1 1.063.852l-.708 2.836a.75.75 0 0 0 1.063.853l.041-.021M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Zm-9-3.75h.008v.008H12V8.25Z" /></svg>
                                            </div>
                                        </Tooltip>
                                        <span className="font-semibold text-emerald-600">+{item.score.toLocaleString()}</span>
                                    </li>
                                  );
                              })}
                               <li className="flex justify-between items-center text-base font-bold p-2 bg-sky-100 rounded-md mt-4">
                                      <span className="text-sky-800">Total Score</span>
                                      <span className="text-sky-800">{myAnalysis.totalScore.toLocaleString()}</span>
                                  </li>
                          </ul>
                      </div>
                  )}
              </div>
          </div>
          <div className="flex items-center gap-4 mt-8">
              {isSolo ? (
                <>
                    <Button onClick={onGoHome} variant="secondary" size="large">Back to Home</Button>
                    <Button onClick={onRetryPrompt} variant="secondary" size="large">Try Same Prompt</Button>
                    <Button onClick={onPlayAgain} size="large">New Prompt</Button>
                </>
              ) : (
                <>
                    <Button onClick={onPlayAgain} size="large">Play Again</Button>
                    <Button onClick={onGoHome} variant="secondary" size="large">Back to Home</Button>
                </>
              )}
          </div>
      </div>
  );
};

const GameScreen = ({ gameData, playerId, onTimeUp, onGoHome, onScoreUpdate }) => {
    const fullCriteria = useMemo(() => {
      if (!gameData || !gameData.criteria) return [];
      return gameData.criteria
          .map(id => ALL_SCORING_CRITERIA.find(c => c.id === id))
          .filter(Boolean);
    }, [gameData]);

    const [title, setTitle] = useState('');
    const [text, setText] = useState('');
    const [planningText, setPlanningText] = useState('');
    const [scoreAnalysis, setScoreAnalysis] = useState(() => analyzeScore('', fullCriteria));
    const [isScoreAnimating, setIsScoreAnimating] = useState(false);
    const hasFired = useRef(false);
    const prevScoreRef = useRef(0);
    const wordCount = useMemo(() => { if (!text.trim()) return 0; return text.trim().split(/\s+/).length; }, [text]);
    
    const onScoreUpdateRef = useRef(onScoreUpdate);
    onScoreUpdateRef.current = onScoreUpdate;

    useEffect(() => {
        const handler = setTimeout(() => {
            const analysis = analyzeScore(text, fullCriteria);
            setScoreAnalysis(analysis);
            if (onScoreUpdateRef.current) {
                onScoreUpdateRef.current(analysis);
            }
            if (analysis.totalScore > prevScoreRef.current) {
                setIsScoreAnimating(true);
                setTimeout(() => setIsScoreAnimating(false), 300);
            }
            prevScoreRef.current = analysis.totalScore;
        }, 500);
        return () => clearTimeout(handler);
    }, [text, fullCriteria]);

    const onTimeUpRef = useRef(onTimeUp);
    onTimeUpRef.current = onTimeUp;

    const handleTimeUp = useCallback(() => {
        if (!hasFired.current) {
            hasFired.current = true;
            const finalAnalysis = analyzeScore(text, fullCriteria);
            onTimeUpRef.current({ title, text }, finalAnalysis);
        }
    }, [title, text, fullCriteria]);

    useEffect(() => {
      if (gameData && gameData.status === 'finished' && !hasFired.current) {
          handleTimeUp();
      }
    }, [gameData, handleTimeUp]);

    const planningPlaceholder = "Jot down your ideas...\n- Beginning: \n- Middle (The Problem): \n- End (The Solution): \n- Senses to include: ";

    return (
        <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div className="lg:col-span-2">
                <div className="relative bg-white p-6 rounded-lg shadow-md border border-slate-200 mb-4">
                    <Button onClick={onGoHome} variant="secondary" size="small" className="absolute top-4 right-4">Quit Game</Button>
                    <div className="flex items-start gap-6">
                        {gameData.promptImageUrl ? (
                             <img 
                                src={gameData.promptImageUrl} 
                                alt="AI generated image for the prompt" 
                                className="w-32 h-32 object-cover rounded-lg shadow-sm border border-slate-200 flex-shrink-0"
                            />
                        ) : (
                            <div className="w-32 h-32 bg-slate-100 rounded-lg flex items-center justify-center flex-shrink-0">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className="w-8 h-8 text-slate-400"><path strokeLinecap="round" strokeLinejoin="round" d="m2.25 15.75 5.159-5.159a2.25 2.25 0 0 1 3.182 0l5.159 5.159m-1.5-1.5 1.409-1.409a2.25 2.25 0 0 1 3.182 0l2.909 2.909m-18 3.75h16.5a1.5 1.5 0 0 0 1.5-1.5V6a1.5 1.5 0 0 0-1.5-1.5H3.75A1.5 1.5 0 0 0 2.25 6v12a1.5 1.5 0 0 0 1.5 1.5Zm10.5-11.25h.008v.008h-.008V8.25Zm.375 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Z" /></svg>
                            </div>
                        )}
                        <div className="flex-grow">
                            <p className="text-sm font-semibold text-sky-600 mb-2">{gameData.prompt.category}</p>
                            <p className="text-lg text-slate-700 pr-20">{gameData.prompt.text}</p>
                        </div>
                    </div>
                </div>
                 <div className="mb-4">
                    <label htmlFor="planning-area" className="block text-sm font-bold text-slate-700 mb-1">Planning</label>
                    <textarea id="planning-area" value={planningText} onChange={(e) => setPlanningText(e.target.value)} className="w-full h-28 p-2 border border-slate-300 rounded-lg shadow-inner focus:ring-2 focus:ring-sky-500 focus:border-sky-500 transition-shadow duration-200 text-sm" placeholder={planningPlaceholder} aria-label="Planning area" />
                </div>
                <div className="mb-4">
                    <label htmlFor="story-title" className="block text-sm font-bold text-slate-700 mb-1">Story Title</label>
                    <input id="story-title" type="text" value={title} onChange={(e) => setTitle(e.target.value)} className="w-full p-3 border border-slate-300 rounded-lg shadow-inner focus:ring-2 focus:ring-sky-500 focus:border-sky-500 transition-shadow duration-200 text-lg" placeholder="Enter your title here" />
                </div>
                <textarea value={text} onChange={(e) => setText(e.target.value)} className="w-full min-h-[400px] p-4 border border-slate-300 rounded-lg shadow-inner focus:ring-2 focus:ring-sky-500 focus:border-sky-500 transition-shadow duration-200" placeholder="Start writing your story here..." aria-label="Story writing area" spellCheck="false" autoComplete="off" autoCorrect="off" autoCapitalize="off" />
            </div>
            <div className="lg:col-span-1">
                <div className="sticky top-8 space-y-6">
                    <div className="bg-sky-600 text-white p-4 rounded-lg shadow-lg text-center"><p className="text-lg font-semibold">Time Remaining</p><Timer startTime={gameData.startTime} duration={gameData.duration} onTimeUp={handleTimeUp} /></div>
                    <div className="bg-emerald-600 text-white p-4 rounded-lg shadow-lg text-center"><p className="text-lg font-semibold">Your Score</p><p className={`text-5xl font-bold tracking-tighter transition-transform duration-300 ease-out ${isScoreAnimating ? 'scale-125' : 'scale-100'}`}>{scoreAnalysis.totalScore.toLocaleString()}</p></div>
                    <div className="bg-violet-600 text-white p-4 rounded-lg shadow-lg text-center"><p className="text-lg font-semibold">Word Count</p><p className="text-5xl font-bold tracking-tighter">{wordCount}</p></div>
                    <div className="bg-white p-6 rounded-lg shadow-md border border-slate-200">
                        <h3 className="text-xl font-bold mb-4 text-slate-800 border-b pb-2">Scoring Goals</h3>
                        <ul className="space-y-1">
                            {fullCriteria.map((criterion) => {
                                const item = scoreAnalysis.breakdown.find(b => b.id === criterion.id) || { count: 0 };
                                const hasAchieved = item.count > 0;
                                return <li key={criterion.id} className={`p-2 rounded-md transition-all duration-300 flex justify-between items-center ${hasAchieved ? 'bg-emerald-50' : 'bg-transparent'}`} aria-live="polite"><span className="text-sm text-slate-600 pr-2"><span className={`font-bold ${hasAchieved ? 'text-emerald-700' : 'text-slate-500'}`}>+{criterion.points.toLocaleString()} pts:</span> {criterion.description}</span><span className={`font-bold text-xs px-2 py-0.5 rounded-full transition-all duration-300 flex-shrink-0 ${hasAchieved ? 'bg-emerald-200 text-emerald-800 scale-110' : 'bg-slate-100 text-slate-500'}`}>{item.count}</span></li>;
                            })}
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    );
};

const HostScreen = ({ gameData, onEndGame }) => {
  const sortedPlayers = Object.entries(gameData.players)
    .map(([id, data]) => ({ id, ...data, totalScore: data.analysis?.totalScore || 0 }))
    .sort((a, b) => b.totalScore - a.totalScore);

  return (
      <div className="flex flex-col items-center">
          <h2 className="text-2xl font-bold text-slate-800 mb-2">Host Dashboard</h2>
          <p className="text-slate-600 mb-6">The game is in progress. You can see the live scores below.</p>
          
          <div className="w-full grid grid-cols-1 lg:grid-cols-3 gap-8">
              <div className="lg:col-span-2">
                  <div className="bg-white p-6 rounded-lg shadow-md border border-slate-200 mb-6">
                      <h3 className="text-xl font-bold mb-4 text-slate-800">Live Leaderboard</h3>
                      {sortedPlayers.length > 0 ? (
                          <ol className="space-y-2">
                              {sortedPlayers.map((player, index) => (
                                  <li key={player.id} className="p-3 rounded-md flex justify-between items-center bg-slate-50 transition-all">
                                      <span className="font-semibold text-slate-700">{index + 1}. {player.nickname}</span>
                                      <span className="font-bold text-sky-600">{player.totalScore.toLocaleString()}</span>
                                  </li>
                              ))}
                          </ol>
                      ) : (
                          <p className="text-slate-500 text-center py-4">Waiting for players to score...</p>
                      )}
                  </div>
              </div>
              <div className="lg:col-span-1 space-y-6">
                   <div className="sticky top-8">
                      <div className="bg-sky-600 text-white p-4 rounded-lg shadow-lg text-center mb-6">
                          <p className="text-lg font-semibold">Time Remaining</p>
                          <Timer startTime={gameData.startTime} duration={gameData.duration} onTimeUp={onEndGame} />
                      </div>
                      <Button onClick={onEndGame} size="large" className="w-full bg-red-600 hover:bg-red-700 focus:ring-red-500">End Game Now</Button>
                  </div>
              </div>
          </div>
      </div>
  );
};

const PlayerDetailModal = ({ player, gamePrompt, onClose }) => {
    if (!player) return null;
    const analysis = player.analysis || { breakdown: [], totalScore: 0 };
    return (
        <div className="fixed inset-0 bg-slate-900/80 backdrop-blur-sm flex items-center justify-center z-50 p-4" onClick={onClose}>
            <div className="bg-white p-6 rounded-xl shadow-2xl w-full max-w-3xl text-left relative" onClick={(e) => e.stopPropagation()}>
                <button onClick={onClose} className="absolute top-3 right-4 text-slate-500 hover:text-slate-800 text-3xl font-bold">&times;</button>
                <h3 className="text-2xl font-bold text-slate-800 mb-4">{player.story?.title || 'Untitled Story'}</h3>
                <p className="text-slate-600 mb-4 -mt-2">by: {player.nickname}</p>
                <div className="grid grid-cols-1 md:grid-cols-3 gap-6 max-h-[70vh]">
                    <div className="md:col-span-2 overflow-y-auto pr-2">
                         <h4 className="text-lg font-bold text-slate-800 mb-2">Full Story</h4>
                         <p className="text-sm font-semibold text-sky-600 mb-2">{gamePrompt.text}</p>
                         <div className="prose max-w-none text-slate-700 whitespace-pre-wrap bg-slate-50 p-4 rounded-md">{player.story?.text || "No text submitted."}</div>
                    </div>
                    <div className="overflow-y-auto">
                        <h4 className="text-lg font-bold text-slate-800 mb-2">Score Breakdown</h4>
                        <ul className="space-y-2">
                           {analysis.breakdown.map((item) => {
                               const criterion = ALL_SCORING_CRITERIA.find(c => c.id === item.id);
                               return (
                                   <li key={item.id} className="flex justify-between items-center text-sm p-2 bg-slate-50 rounded-md">
                                       <Tooltip text={criterion?.description || 'No description available.'}>
                                           <div className="flex items-center gap-1.5 cursor-help">
                                               <span className="text-slate-700">{item.name} ({item.count})</span>
                                               <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className="w-4 h-4 text-slate-400"><path strokeLinecap="round" strokeLinejoin="round" d="m11.25 11.25.041-.02a.75.75 0 0 1 1.063.852l-.708 2.836a.75.75 0 0 0 1.063.853l.041-.021M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Zm-9-3.75h.008v.008H12V8.25Z" /></svg>
                                           </div>
                                       </Tooltip>
                                       <span className="font-semibold text-emerald-600">+{item.score.toLocaleString()}</span>
                                   </li>
                               );
                           })}
                            <li className="flex justify-between items-center text-base font-bold p-2 bg-sky-100 rounded-md mt-4">
                                   <span className="text-sky-800">Total Score</span>
                                   <span className="text-sky-800">{analysis.totalScore.toLocaleString()}</span>
                               </li>
                       </ul>
                       <Button onClick={() => downloadPDF(player.nickname, player.story, gamePrompt)} size="medium" className="mt-6 w-full">Download as PDF</Button>
                    </div>
                </div>
            </div>
        </div>
    );
};

const HostResultsScreen = ({ gameData, onNewGame, onGoHome, isHistoryView = false, onBackToDashboard }) => {
  const [selectedPlayer, setSelectedPlayer] = useState(null);

  const sortedPlayers = Object.entries(gameData.players)
    .map(([id, data]) => ({ id, ...data, totalScore: data.analysis?.totalScore || 0 }))
    .sort((a, b) => b.totalScore - a.totalScore);

  return (
      <div className="flex flex-col items-center">
          <h2 className="text-3xl font-bold text-emerald-600 mb-2">{isHistoryView ? "Game Results" : "Game Over!"}</h2>
          <p className="text-slate-600 mb-6">{isHistoryView ? "Here are the results for this game session." : "Here are the final results and all the amazing stories written."}</p>
          <div className="w-full max-w-2xl bg-white p-6 rounded-lg shadow-md border border-slate-200">
               <h3 className="text-xl font-bold text-slate-500 uppercase tracking-wider mb-3">Final Leaderboard</h3>
               {sortedPlayers.length > 0 ? (
                  <ol className="space-y-2">
                   {sortedPlayers.map((player, index) => (
                      <li key={player.id} className="p-3 rounded-md flex justify-between items-center bg-slate-50">
                        <div className="flex items-center gap-4">
                         <span className="font-bold text-slate-600 text-lg w-6">{index + 1}.</span>
                         <span className="font-semibold text-slate-800 text-lg">{player.nickname}</span>
                         <span className="font-bold text-sky-600">{player.totalScore.toLocaleString()}</span>
                        </div>
                        <Button onClick={() => setSelectedPlayer(player)} size="small">View Writing</Button>
                      </li>
                   ))}
                  </ol>
               ) : (
                  <p className="text-slate-500 text-center py-4">No players submitted a score.</p>
               )}
          </div>
           <div className="flex items-center gap-4 mt-8">
              {isHistoryView ? (
                  <Button onClick={onBackToDashboard} variant="secondary" size="large">Back to Dashboard</Button>
              ) : (
                  <>
                      <Button onClick={onNewGame} size="large">Create New Game</Button>
                      <Button onClick={onGoHome} variant="secondary" size="large">Back to Home</Button>
                  </>
              )}
          </div>
          {selectedPlayer && <PlayerDetailModal player={selectedPlayer} gamePrompt={gameData.prompt} onClose={() => setSelectedPlayer(null)} />}
      </div>
  );
};

const LobbyScreen = ({ gameId, gameData, playerId, onStartGame }) => {
  const isHost = gameData.hostId === playerId;
  const playerList = Object.entries(gameData.players);

  const handleCopyCode = () => {
      navigator.clipboard.writeText(gameId);
  };

  return (
      <div className="flex flex-col items-center">
          <h2 className="text-2xl font-bold text-slate-800 mb-2">Game Lobby</h2>
          <p className="text-slate-600 mb-6">Share the code with your friends! The game will begin when the host starts.</p>
          <div className="mb-6">
              <p className="text-sm text-slate-500">GAME CODE</p>
              <div className="flex items-center gap-2 mt-1">
                  <p className="text-4xl font-bold tracking-widest text-sky-600 bg-sky-100 p-3 rounded-lg">{gameId}</p>
                  <Button onClick={handleCopyCode} variant="secondary" title="Copy Code">
                       <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className="w-6 h-6"><path strokeLinecap="round" strokeLinejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 01-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 011.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 00-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 01-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 00-3.375-3.375h-1.5a1.125 1.125 0 01-1.125-1.125v-1.5a3.375 3.375 0 00-3.375-3.375H9.75" /></svg>
                  </Button>
              </div>
          </div>

          <div className="w-full max-w-md bg-white p-6 rounded-lg shadow-md border border-slate-200 mb-8">
              <h3 className="text-xl font-bold mb-4 text-slate-800">Players ({playerList.length})</h3>
              <ul className="space-y-2">
                  {playerList.map(([id, player]) => (
                      <li key={id} className="flex items-center gap-3 p-2 bg-slate-100 rounded-md">
                         <span className="font-bold text-slate-700">{player.nickname}</span>
                         {gameData.hostId === id && <span className="text-xs font-bold text-sky-700 bg-sky-200 px-2 py-0.5 rounded-full">HOST (Not Playing)</span>}
                      </li>
                  ))}
                  {playerList.length === 0 && <p className="text-slate-500 text-center py-2">Waiting for players to join...</p>}
              </ul>
          </div>

          {isHost ? (
              <Button onClick={onStartGame} size="large" disabled={playerList.length === 0}>Start Game for Everyone!</Button>
          ) : (
              <p className="text-lg text-slate-600 animate-pulse">Waiting for host to start the game...</p>
          )}
      </div>
  );
};

const JoinGameScreen = ({ onJoin, onGoHome }) => {
    const [gameCode, setGameCode] = useState('');
    const [error, setError] = useState('');
    const [isLoading, setIsLoading] = useState(false);

    const handleJoin = async (e) => {
      e.preventDefault();
      if (!gameCode.trim()) return;
      setError('');
      setIsLoading(true);
      try {
          await onJoin(gameCode.trim().toUpperCase());
      } catch (err) {
          setError(err.message);
      } finally {
          setIsLoading(false);
      }
    };

    return (
        <div className="flex flex-col items-center">
            <h2 className="text-2xl font-bold text-slate-800 mb-2">Join a Game</h2>
            <p className="text-slate-600 mb-6">Enter the 6-character code from your game host.</p>
            <form onSubmit={handleJoin} className="w-full max-w-sm flex flex-col items-center">
                <input
                  type="text"
                  value={gameCode}
                  onChange={(e) => setGameCode(e.target.value)}
                  className="w-full p-3 border border-slate-300 rounded-lg shadow-inner focus:ring-2 focus:ring-sky-500 focus:border-sky-500 transition-shadow duration-200 text-2xl text-center tracking-[0.5em] uppercase"
                  placeholder="ABCXYZ"
                  maxLength={6}
                  required
                />
                {error && <p className="text-red-500 mt-2">{error}</p>}
                <div className="flex items-center gap-4 mt-8">
                  <Button onClick={onGoHome} variant="secondary" size="large" type="button">Back to Home</Button>
                  <Button type="submit" size="large" disabled={isLoading}>{isLoading ? 'Joining...' : 'Join Game'}</Button>
                </div>
            </form>
        </div>
    );
};

const SetupScreen = ({ onStart, onGoHome, onBackToDashboard, isSolo = false, isTeacher = false }) => {
    const [currentPrompt, setCurrentPrompt] = useState(() => NARRATIVE_PROMPTS[Math.floor(Math.random() * NARRATIVE_PROMPTS.length)]);
    const [duration, setDuration] = useState(5);
    const [useCustomPrompt, setUseCustomPrompt] = useState(false);
    const [customPromptText, setCustomPromptText] = useState('');
    const [isGenerating, setIsGenerating] = useState(false);

    const generateNewPrompt = useCallback(() => {
        const newPrompt = NARRATIVE_PROMPTS[Math.floor(Math.random() * NARRATIVE_PROMPTS.length)];
        setCurrentPrompt(newPrompt);
    }, []);

    const selectedCriteria = useMemo(() => {
        const alwaysGoals = ALL_SCORING_CRITERIA.filter(c => c.type === 'always');
        const randomGoalsPool = ALL_SCORING_CRITERIA.filter(c => c.type === 'random');
        const shuffled = [...randomGoalsPool].sort(() => 0.5 - Math.random());
        const selectedRandomGoals = shuffled.slice(0, 3);
        return [...alwaysGoals, ...selectedRandomGoals];
    }, [currentPrompt]);

    const handleStart = async () => {
        const criteriaIds = selectedCriteria.map(c => c.id);
        const promptToUse = useCustomPrompt && isTeacher 
            ? { category: "Teacher's Choice", text: customPromptText.trim() }
            : currentPrompt;

        if (useCustomPrompt && isTeacher && !customPromptText.trim()) {
            alert("Please enter your custom prompt before starting the game.");
            return;
        }

        setIsGenerating(true);
        try {
            await onStart(promptToUse, criteriaIds, duration * 60);
        } catch (error) {
            console.error("Failed to start game:", error);
            alert("There was an error generating the game image. Please check the console and try again.");
        } finally {
            setIsGenerating(false);
        }
    };
    
    return (
        <div className="flex flex-col items-center">
            <h2 className="text-2xl font-bold text-slate-800 mb-2">{isSolo ? "Solo Mode" : "Create a Game"}</h2>
            <p className="text-slate-600 mb-6">Generate a story idea and choose the writing time.</p>
            <div className="w-full max-w-3xl bg-white p-6 rounded-lg shadow-md border border-slate-200 mb-6">
              {isTeacher && !isSolo && useCustomPrompt ? (
                  <div>
                      <label htmlFor="custom-prompt" className="block text-sm font-semibold text-sky-600 mb-2">Enter Your Custom Prompt</label>
                      <textarea 
                          id="custom-prompt"
                          value={customPromptText}
                          onChange={(e) => setCustomPromptText(e.target.value)}
                          className="w-full p-2 border border-slate-300 rounded-lg shadow-inner focus:ring-2 focus:ring-sky-500 focus:border-sky-500 transition-all duration-200"
                          rows="3"
                          placeholder="e.g., A friendly dragon has lost its roar. Write a story about how it gets it back."
                      />
                  </div>
              ) : (
                  <>
                      <p className="text-sm font-semibold text-sky-600 mb-2">{currentPrompt.category}</p>
                      <p className="text-lg text-slate-700">{currentPrompt.text}</p>
                  </>
              )}
            </div>
            <div className="flex items-center gap-4 mb-6">
              {!(isTeacher && useCustomPrompt) && (
                  <Button onClick={generateNewPrompt} variant="secondary">
                      Generate New Prompt
                  </Button>
              )}
              {isTeacher && !isSolo && (
                  <Button onClick={() => setUseCustomPrompt(prev => !prev)} variant="secondary">
                      {useCustomPrompt ? "Use a Random Prompt" : "Write My Own Prompt"}
                  </Button>
              )}
            </div>
            <div className="w-full max-w-sm mb-8">
                <label htmlFor="duration" className="block text-center text-sm font-medium text-slate-700 mb-2">Set Timer (minutes)</label>
                <div className="flex items-center justify-center gap-4">
                    <input type="range" id="duration" min={5} max={45} step={5} value={duration} onChange={(e) => setDuration(parseInt(e.target.value))} className="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer dark:bg-slate-700" />
                    <span className="font-bold text-sky-600 text-lg w-12 text-center">{duration}</span>
                </div>
            </div>
            <div className="flex items-center gap-4">
              <Button onClick={isTeacher ? onBackToDashboard : onGoHome} variant="secondary" size="large">{isTeacher ? "Back to Dashboard" : "Back to Home"}</Button>
              <Button onClick={handleStart} size="large" disabled={isGenerating}>
                  {isGenerating ? (
                      <span className="flex items-center justify-center gap-2">
                          <div className="w-5 h-5 border-2 border-white/50 border-t-white rounded-full animate-spin"></div>
                          Generating...
                      </span>
                  ) : (isSolo ? "Start Writing!" : "Create Game Lobby")}
              </Button>
            </div>
        </div>
    );
};

const PlayerHistoryModal = ({ player, onClose }) => {
    const [viewingWriting, setViewingWriting] = useState(null);
    if (!player) return null;

    const formatDate = (timestamp) => {
        if (!timestamp) return 'N/A';
        return timestamp.toDate().toLocaleDateString('en-US', {
            month: 'short', day: 'numeric', year: 'numeric'
        });
    }

    return (
        <div className="fixed inset-0 bg-slate-900/80 backdrop-blur-sm flex items-center justify-center z-50 p-4" onClick={onClose}>
            <div className="bg-white p-6 rounded-xl shadow-2xl w-full max-w-3xl text-left relative" onClick={(e) => e.stopPropagation()}>
                <button onClick={onClose} className="absolute top-3 right-4 text-slate-500 hover:text-slate-800 text-3xl font-bold">&times;</button>
                <h3 className="text-2xl font-bold text-slate-800 mb-4">Writing History for <span className="text-sky-600">{player.nickname}</span></h3>
                <div className="space-y-3 max-h-[70vh] overflow-y-auto pr-2">
                    {player.writings.length > 0 ? player.writings.map((writing, index) => (
                        <div key={`${player.id}-${index}`} className="bg-slate-50 p-3 rounded-lg border border-slate-200 flex justify-between items-center">
                            <div>
                                <p className="font-semibold text-slate-700 truncate" title={writing.prompt?.text}>{writing.story?.title || 'Untitled Story'}</p>
                                <p className="text-sm text-slate-500">{formatDate(writing.createdAt)} &bull; Score: <span className="font-bold">{(writing.analysis?.totalScore || 0).toLocaleString()}</span></p>
                                <p className="text-xs text-slate-500 mt-1">Authors: {writing.authors}</p>
                            </div>
                            <Button onClick={() => setViewingWriting(writing)} size="small" variant="secondary">View Writing</Button>
                        </div>
                    )) : <p className="text-slate-500 text-center py-4">This player has not submitted any writing yet.</p>}
                </div>
            </div>
            {viewingWriting && (
                <PlayerDetailModal 
                    player={{ nickname: viewingWriting.authors, story: viewingWriting.story, analysis: viewingWriting.analysis }}
                    gamePrompt={viewingWriting.prompt}
                    onClose={() => setViewingWriting(null)}
                />
            )}
        </div>
    );
};

const TeacherDashboard = ({ currentUser, onCreateNewGame, onViewGame, onSignOut }) => {
  const [games, setGames] = useState([]);
  const [playersData, setPlayersData] = useState(null);
  const [loading, setLoading] = useState(true);
  const [activeTab, setActiveTab] = useState('games');
  const [viewingPlayer, setViewingPlayer] = useState(null);

  useEffect(() => {
      if (!currentUser) return;
      const unsubscribe = getGamesForTeacher(currentUser.uid, (fetchedGames) => {
          setGames(fetchedGames);
          
          const aggregatedPlayers = {};
          fetchedGames.forEach(game => {
              Object.entries(game.players).forEach(([playerId, playerData]) => {
                  if (playerData.analysis && playerData.nickname) {
                      const nicknames = playerData.nickname.split(',').map(name => name.trim()).filter(Boolean);

                      nicknames.forEach(individualNickname => {
                          if (!aggregatedPlayers[individualNickname]) {
                              aggregatedPlayers[individualNickname] = {
                                  id: individualNickname,
                                  nickname: individualNickname,
                                  writings: []
                              };
                          }
                          
                          aggregatedPlayers[individualNickname].writings.push({
                              gameId: game.id,
                              prompt: game.prompt,
                              createdAt: game.createdAt,
                              story: playerData.story || { title: '', text: '' },
                              analysis: playerData.analysis,
                              authors: playerData.nickname 
                          });
                      });
                  }
              });
          });
          
          Object.values(aggregatedPlayers).forEach((p) => {
              p.writings.sort((a, b) => (b.createdAt?.toDate() || 0) - (a.createdAt?.toDate() || 0));
          });

          setPlayersData(aggregatedPlayers);
          setLoading(false);
      });
      return () => unsubscribe();
  }, [currentUser]);

  const sortedPlayers = useMemo(() => {
      if (!playersData) return [];
      return Object.values(playersData).sort((a, b) => a.nickname.localeCompare(b.nickname));
  }, [playersData]);

  const formatDate = (timestamp) => {
      if (!timestamp) return 'Just now';
      return timestamp.toDate().toLocaleDateString('en-US', {
          year: 'numeric', month: 'long', day: 'numeric'
      });
  }

  const TabButton = ({ isActive, onClick, children }) => (
      <button 
        onClick={onClick}
        className={`px-4 py-2 text-sm font-semibold rounded-md transition-colors ${isActive ? 'bg-sky-600 text-white' : 'text-slate-600 hover:bg-slate-200'}`}
      >
        {children}
      </button>
  );

  return (
      <div>
          <div className="flex justify-between items-start mb-6">
              <div>
                  <h2 className="text-2xl font-bold text-slate-800">Teacher Dashboard</h2>
                  <p className="text-slate-600">Welcome, {currentUser.displayName || 'Teacher'}!</p>
              </div>
              <Button onClick={onSignOut} variant="primary">Sign Out</Button>
          </div>
          <div className="text-center mb-8">
              <Button onClick={onCreateNewGame} size="large">
                  <span className="flex items-center gap-2">
                      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className="w-6 h-6"><path strokeLinecap="round" strokeLinejoin="round" d="M12 4.5v15m7.5-7.5h-15" /></svg>
                      Create New Game
                  </span>
              </Button>
          </div>
          
          <div className="mb-4 flex items-center gap-2 p-1 bg-slate-100 rounded-lg max-w-sm mx-auto">
              <TabButton isActive={activeTab === 'games'} onClick={() => setActiveTab('games')}>Game History</TabButton>
              <TabButton isActive={activeTab === 'players'} onClick={() => setActiveTab('players')}>Player History</TabButton>
          </div>

          <div>
              {loading ? (
                  <div className="flex justify-center p-8"><LoadingSpinner /></div>
              ) : activeTab === 'games' ? (
                  games.length > 0 ? (
                      <div className="space-y-4">
                          {games.map(game => (
                              <div key={game.id} className="bg-white p-4 rounded-lg shadow-md border border-slate-200 flex justify-between items-center">
                                  <div>
                                      <p className="font-semibold text-sky-700">{game.prompt.text}</p>
                                      <p className="text-sm text-slate-500">{formatDate(game.createdAt)} &bull; {Object.keys(game.players).length} players</p>
                                  </div>
                                  <Button onClick={() => onViewGame(game)} size="small" variant="secondary">View Results</Button>
                              </div>
                          ))}
                      </div>
                  ) : (
                      <div className="text-center bg-slate-100 p-8 rounded-lg">
                          <p className="text-slate-600">You haven't hosted any games yet.</p>
                          <p className="text-slate-500 text-sm mt-1">Click "Create New Game" to get started!</p>
                      </div>
                  )
              ) : (
                  sortedPlayers.length > 0 ? (
                      <div className="space-y-4">
                          {sortedPlayers.map((player) => (
                              <div key={player.id} className="bg-white p-4 rounded-lg shadow-md border border-slate-200 flex justify-between items-center">
                                  <div>
                                      <p className="font-semibold text-sky-700">{player.nickname}</p>
                                      <p className="text-sm text-slate-500">{player.writings.length} stories written</p>
                                  </div>
                                  <Button onClick={() => setViewingPlayer(player)} size="small" variant="secondary">View History</Button>
                              </div>
                          ))}
                      </div>
                  ) : (
                      <div className="text-center bg-slate-100 p-8 rounded-lg">
                          <p className="text-slate-600">No player data found yet.</p>
                          <p className="text-slate-500 text-sm mt-1">Player history will appear here after they complete a game.</p>
                      </div>
                  )
              )}
          </div>
          {viewingPlayer && <PlayerHistoryModal player={viewingPlayer} onClose={() => setViewingPlayer(null)} />}
      </div>
  );
};

const SentenceBuilderScreen = ({ onGoHome }) => {
    const [stage, setStage] = useState('rewrite');
    const [rootSentence, setRootSentence] = useState(() => SENTENCE_ROOTS[Math.floor(Math.random() * SENTENCE_ROOTS.length)]);
    const [userSentence, setUserSentence] = useState('');
    const [score, setScore] = useState(null);
    const [activeKeteTab, setActiveKeteTab] = useState(Object.keys(KETE_WORDS)[0]);
    const [highScore, setHighScore] = useState(0);
    
    const handleNext = () => {
        if (userSentence.trim().length > rootSentence.root.length) {
            setStage('kete');
        } else {
            alert("Try adding a bit more to your sentence before moving on!");
        }
    };
    
    const calculateMechanicalScore = (baseSentence, newSentence, baseVerb) => {
        let score = 0;
        const baseWords = new Set(baseSentence.toLowerCase().match(/\b\w+\b/g));
        const newWords = newSentence.toLowerCase().match(/\b\w+\b/g) || [];

        const addedWords = newWords.filter(word => !baseWords.has(word));

        score += countWords(addedWords.join(' '), ADJECTIVES) * 10;
        score += countWords(addedWords.join(' '), Object.values(KETE_WORDS).flat()) * 5;
        
        if (!newSentence.toLowerCase().includes(baseVerb)) {
            score += 25;
        }

        return score;
    };

    const handleGetScore = async () => {
        setStage('scoring');
        const mechanicalScore = calculateMechanicalScore(rootSentence.root, userSentence, rootSentence.verb);
        const geminiResult = await getSentenceFeedback(rootSentence.root, userSentence);
        
        const finalScore = Math.round(mechanicalScore * geminiResult.qualityScore);

        setScore({
            mechanicalScore,
            qualityScore: geminiResult.qualityScore,
            feedback: geminiResult.feedback,
            finalScore
        });

        if (finalScore > highScore) {
            setHighScore(finalScore);
        }

        setStage('results');
    };
    
    const handleTryAgain = () => {
        setStage('rewrite');
        setRootSentence(SENTENCE_ROOTS[Math.floor(Math.random() * SENTENCE_ROOTS.length)]);
        setUserSentence('');
        setScore(null);
        setHighScore(0);
    };

    const handleRetrySameSentence = () => {
        setStage('rewrite');
        setUserSentence('');
        setScore(null);
    };

    if (stage === 'scoring') {
        return (
            <div className="flex flex-col items-center justify-center text-center p-8 min-h-[300px]">
                <LoadingSpinner />
                <p className="text-slate-600 mt-4 font-semibold text-lg animate-pulse">Our AI is reading your sentence...</p>
            </div>
        );
    }
    
    if (stage === 'results') {
        return (
            <div className="text-center">
                <h2 className="text-2xl font-bold text-slate-800 mb-4">Your Results!</h2>
                <div className="bg-slate-100 p-4 rounded-lg mb-4">
                    <p className="text-sm text-slate-500">Original Sentence</p>
                    <p className="font-semibold">{rootSentence.root}</p>
                </div>
                <div className="bg-sky-100 p-4 rounded-lg mb-6">
                    <p className="text-sm text-sky-700">Your Awesome Sentence</p>
                    <p className="font-semibold text-sky-900 text-lg">{userSentence}</p>
                </div>
                
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                    <div className="bg-white p-4 rounded-lg shadow-md border border-slate-200">
                        <p className="text-sm font-bold text-slate-500">HIGH SCORE</p>
                        <p className="text-3xl font-bold text-amber-500">{highScore}</p>
                    </div>
                    <div className="bg-emerald-600 text-white p-4 rounded-lg shadow-lg">
                        <p className="text-sm font-bold">YOUR SCORE</p>
                        <p className="text-3xl font-bold">{score.finalScore}</p>
                    </div>
                </div>

                <div className="bg-amber-100 border-l-4 border-amber-500 text-amber-800 p-4 rounded-r-lg mb-8">
                    <p className="font-bold">AI Feedback:</p>
                    <p>"{score.feedback}"</p>
                </div>

                <div className="flex items-center justify-center gap-4">
                    <Button onClick={onGoHome} variant="secondary" size="large">Back to Home</Button>
                    <Button onClick={handleRetrySameSentence} variant="secondary" size="large">Try Again</Button>
                    <Button onClick={handleTryAgain} size="large">New Sentence</Button>
                </div>
            </div>
        );
    }

    return (
        <div className="flex flex-col items-center">
             <h2 className="text-2xl font-bold text-slate-800 mb-2">Sentence Lab</h2>
             <p className="text-slate-600 mb-6 max-w-2xl text-center">Let's turn a simple sentence into something amazing. {stage === 'rewrite' ? 'First, rewrite it on your own!' : 'Now, use the Kete for inspiration!'}</p>

             <div className="w-full max-w-3xl">
                 <div className="bg-slate-100 p-4 rounded-lg mb-4 text-center">
                    <p className="text-sm text-slate-500">Your starting sentence:</p>
                    <p className="text-xl font-semibold text-slate-800">{rootSentence.root}</p>
                 </div>
                 
                 <textarea 
                     value={userSentence}
                     onChange={(e) => setUserSentence(e.target.value)}
                     className="w-full p-4 border border-slate-300 rounded-lg shadow-inner focus:ring-2 focus:ring-sky-500 focus:border-sky-500 transition-shadow duration-200 text-lg"
                     rows="3"
                     placeholder={stage === 'rewrite' ? "Rewrite the sentence here..." : "Refine your sentence..."}
                 />
                 
                 {stage === 'kete' && (
                     <div className="mt-6 bg-white p-4 rounded-lg shadow-md border border-slate-200">
                         <h3 className="text-lg font-bold text-slate-700 mb-2">The Kete (Word Bank)</h3>
                         <div className="flex flex-wrap gap-2 border-b border-slate-200 mb-3 pb-2">
                             {Object.keys(KETE_WORDS).map(tabName => (
                                 <button key={tabName} onClick={() => setActiveKeteTab(tabName)} className={`px-3 py-1 text-sm font-semibold rounded-full ${activeKeteTab === tabName ? 'bg-sky-600 text-white' : 'bg-slate-200 text-slate-700 hover:bg-slate-300'}`}>
                                     {tabName}
                                 </button>
                             ))}
                         </div>
                         <div className="flex flex-wrap gap-2">
                             {KETE_WORDS[activeKeteTab].map(word => (
                                 <span key={word} className="bg-slate-100 text-slate-800 px-2 py-1 rounded-md text-sm cursor-default">
                                     {word}
                                 </span>
                             ))}
                         </div>
                     </div>
                 )}

                <div className="flex items-center justify-center gap-4 mt-8">
                    <Button onClick={onGoHome} variant="secondary" size="large">Back to Home</Button>
                    {stage === 'rewrite' ? (
                        <Button onClick={handleNext} size="large" disabled={!userSentence.trim()}>Next Step</Button>
                    ) : (
                        <Button onClick={handleGetScore} size="large" disabled={!userSentence.trim()}>Get My Score!</Button>
                    )}
                </div>
             </div>
        </div>
    );
};

const ModeCard = ({ title, description, icon, onClick, disabled, buttonText }) => (
    <div className={`p-6 rounded-xl shadow-md flex flex-col items-center text-center transition-all duration-300 h-full ${disabled ? 'bg-slate-200 text-slate-500' : 'bg-white hover:shadow-xl hover:-translate-y-1'}`}>
        <div className={`w-16 h-16 rounded-full flex items-center justify-center mb-4 ${disabled ? 'bg-slate-300' : 'bg-sky-100 text-sky-600'}`}>
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className="w-8 h-8"><path strokeLinecap="round" strokeLinejoin="round" d={icon} /></svg>
        </div>
        <h3 className="text-xl font-bold mb-2">{title}</h3>
        <p className="text-sm mb-4 flex-grow">{description}</p>
        <Button onClick={onClick} disabled={disabled} className="mt-auto">{buttonText}</Button>
    </div>
);

const HomeScreen = ({ onSelectTeacherLogin, onSelectDashboard, onSelectJoin, onSelectSolo, onSelectSentenceBuilder, currentUser }) => (
    <div className="text-center">
        <h2 className="text-3xl font-bold text-slate-800 mb-4">Welcome!</h2>
        <p className="text-lg text-slate-600 mb-8 max-w-3xl mx-auto">Choose a mode to begin your writing adventure. Sharpen your skills, join a friend's game, or create a challenge for your class!</p>
        <div className="grid grid-cols-1 lg:grid-cols-2 gap-8 max-w-5xl mx-auto">
            
            <div className="bg-sky-50/50 p-6 rounded-xl border border-sky-200">
                <h3 className="text-2xl font-bold text-sky-700 mb-4">Multi-Player Game</h3>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <ModeCard 
                      title={currentUser ? "Teacher Dashboard" : "Create a Game"}
                      description={currentUser ? "View game history and create new challenges for your students." : "Sign in to be the game master! Choose prompts and set timers."}
                      icon={currentUser ? "M3.75 3v11.25A2.25 2.25 0 006 16.5h12A2.25 2.25 0 0020.25 14.25V3.75A2.25 2.25 0 0018 1.5H6A2.25 2.25 0 003.75 3zM12 18.75a.75.75 0 01.75.75v.008a.75.75 0 01-.75.75h-.008a.75.75 0 01-.75-.75v-.008a.75.75 0 01.75.75h.008z" : "M12 4.5v15m7.5-7.5h-15" }
                      onClick={currentUser ? onSelectDashboard : onSelectTeacherLogin} 
                      buttonText={currentUser ? "Go to Dashboard" : "Teacher Login"}
                      disabled={false}
                    />
                    <ModeCard 
                      title="Join a Game" 
                      description="Got a game code? Enter it here to join a writing quest with your classmates." 
                      icon="M15.75 6a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0zM4.501 20.118a7.5 7.5 0 0114.998 0A17.933 17.933 0 0112 21.75c-2.676 0-5.216-.584-7.499-1.632z" 
                      onClick={onSelectJoin} 
                      disabled={false} 
                      buttonText="Join Game" 
                    />
                </div>
            </div>

            <div className="bg-emerald-50/50 p-6 rounded-xl border border-emerald-200">
                <h3 className="text-2xl font-bold text-emerald-700 mb-4">Writer's Workshop</h3>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <ModeCard 
                      title="Solo Game Mode" 
                      description="Fly solo! Get a random prompt and practice your writing skills." 
                      icon="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09z" 
                      onClick={onSelectSolo} 
                      disabled={false} 
                      buttonText="Start Writing" 
                    />
                    <ModeCard 
                      title="Sentence Lab" 
                      description="Practice creating amazing sentences! Start with a simple idea and make it shine." 
                      icon="M16.47,4.36,15.11,3,13.75,4.36,12.39,3,11,4.36,9.64,3,8.28,4.36,6.92,3,5.56,4.36,4.2,3,3,4.2,4.36,5.56,3,6.92,4.36,8.28,3,9.64,4.36,11,3,12.39,4.36,13.75,3,15.11,4.36,16.47,3,17.83,4.36,19.19,3,20.55,4.2,21.91,5.56,20.55,6.92,21.91,8.28,20.55,9.64,21.91,11,20.55,12.39,21.91,13.75,20.55,15.11,21.91,16.47,20.55,17.83,21.91,19.19,20.55,20.55,19.19,21.91,17.83,20.55,16.47,21.91,15.11,20.55,13.75,21.91,12.39,20.55,11,21.91,9.64,20.55,8.28,21.91,6.92,20.55,5.56,21.91,4.2,20.55,3,19.19,4.36,17.83,3,16.47,4.36Z" 
                      onClick={onSelectSentenceBuilder} 
                      disabled={false} 
                      buttonText="Enter the Lab" 
                    />
                </div>
            </div>
        </div>
    </div>
);

const App = () => {
    const [gameState, setGameState] = useState(GameState.Home);
    const [playerId, setPlayerId] = useState(null);
    const [playerNickname, setPlayerNickname] = useState(null);
    const [gameId, setGameId] = useState(null);
    const [gameData, setGameData] = useState(null);
    const [soloData, setSoloData] = useState(null);
    const [finalStory, setFinalStory] = useState(null);
    const [scoreAnalysis, setScoreAnalysis] = useState(null);
    const [currentUser, setCurrentUser] = useState(null);
    const [viewingGameData, setViewingGameData] = useState(null);
    const [authLoading, setAuthLoading] = useState(true);
    const [soloHighScore, setSoloHighScore] = useState(0);

    useEffect(() => {
      let storedPlayerId = localStorage.getItem('inkxp_playerId');
      if (!storedPlayerId) {
          storedPlayerId = `player_${Math.random().toString(36).substring(2, 11)}`;
          localStorage.setItem('inkxp_playerId', storedPlayerId);
      }
      setPlayerId(storedPlayerId);
      
      const unsubscribe = onAuthChange(user => {
          setCurrentUser(user);
          setAuthLoading(false);
      });
      return () => unsubscribe();
    }, []);

    useEffect(() => {
      if (!gameId) return;
      const unsubscribe = getGameStream(gameId, (data) => {
          if (data) {
              setGameData(data);
              if (data.status === 'in-progress') setGameState(GameState.InGame);
              if (data.status === 'finished') setGameState(GameState.Results);
          } else {
              alert("Game session not found or has been deleted.");
              handleGoHome();
          }
      });
      return () => unsubscribe();
    }, [gameId]);
    
    const handleSetNickname = useCallback((nickname) => {
      setPlayerNickname(nickname);
    }, []);

    const handleTeacherLogin = async () => {
      try {
          await signInWithGoogle();
          setGameState(GameState.TeacherDashboard);
      } catch (error) {
          console.error("Error signing in: ", error);
          alert("Could not sign in with Google. Please try again.");
      }
    };
    
    const handleSignOut = async () => {
        await signOutUser();
        setGameState(GameState.Home);
    };

    const handleCreateLobby = async (prompt, criteriaIds, duration) => {
      if (!currentUser) {
          alert("You must be signed in to create a game.");
          return;
      }
      const promptImageUrl = await generateImageForPrompt(prompt.text);
      const newGameId = await createGame(playerId, prompt, criteriaIds, duration, currentUser.uid, promptImageUrl);
      setGameId(newGameId);
      setGameState(GameState.Lobby);
    };

    const handleJoinGame = async (code) => {
      await joinGame(code, playerId, playerNickname);
      setGameId(code);
      setGameState(GameState.Lobby);
    };

    const handleStartGame = async () => await startGame(gameId);
    
    const handleForceEndGame = useCallback(async () => {
      if (gameId) {
          await finishGame(gameId);
      }
    }, [gameId]);

    const handleStartSolo = useCallback(async (prompt, criteriaIds, duration) => {
        const promptImageUrl = await generateImageForPrompt(prompt.text);
        setSoloData({ prompt, criteria: criteriaIds, duration, promptImageUrl });
        setSoloHighScore(0);
        setGameState(GameState.InGame);
    }, []);
    
    const handleRetrySolo = useCallback(() => {
        setFinalStory(null);
        setScoreAnalysis(null);
        setGameState(GameState.InGame);
    }, []);

    const handleEndSolo = useCallback((story, analysis) => {
        setFinalStory(story);
        setScoreAnalysis(analysis);
        if (analysis.totalScore > soloHighScore) {
            setSoloHighScore(analysis.totalScore);
        }
        setGameState(GameState.Results);
    }, [soloHighScore]);

    const handleEndMultiplayerGame = useCallback(async (story, analysis) => {
      await submitResult(gameId, playerId, story, analysis);
    }, [gameId, playerId]);
    
    const handleScoreUpdate = useCallback(async (analysis) => {
        if (gameId && playerId) {
            await updatePlayerAnalysis(gameId, playerId, analysis);
        }
    }, [gameId, playerId]);
    
    const handleViewGameHistory = (game) => {
      setViewingGameData(game);
      setGameState(GameState.Results);
    };

    const resetGame = useCallback(() => {
        setGameId(null);
        setGameData(null);
        setSoloData(null);
        setFinalStory(null);
        setScoreAnalysis(null);
        setViewingGameData(null);
        setSoloHighScore(0);
    }, []);

    const handleGoToDashboard = useCallback(() => {
        resetGame();
        setGameState(GameState.TeacherDashboard);
    }, [resetGame]);

    const handleGoHome = useCallback(() => {
        resetGame();
        setGameState(GameState.Home);
    }, [resetGame]);
    
    const handleGoToSoloSetup = useCallback(() => {
        resetGame();
        setGameState(GameState.SoloSetup);
    }, [resetGame]);

    const renderContent = () => {
        if (authLoading) {
          return <div className="flex justify-center p-8"><LoadingSpinner /></div>;
        }

        const shouldPromptForNickname = playerId && !playerNickname && 
          (gameState === GameState.JoinGameSetup || (gameState === GameState.Lobby && gameData && !gameData.players[playerId] && gameData.hostId !== playerId));

        if (shouldPromptForNickname) {
          return <NicknamePrompt onNicknameSubmit={handleSetNickname} />;
        }

        switch (gameState) {
            case GameState.Home:
              return <HomeScreen 
                  currentUser={currentUser}
                  onSelectTeacherLogin={handleTeacherLogin}
                  onSelectDashboard={() => setGameState(GameState.TeacherDashboard)}
                  onSelectJoin={() => setGameState(GameState.JoinGameSetup)}
                  onSelectSolo={() => setGameState(GameState.SoloSetup)} 
                  onSelectSentenceBuilder={() => setGameState(GameState.SentenceBuilder)}
                  />;
            case GameState.SentenceBuilder:
                return <SentenceBuilderScreen onGoHome={handleGoHome} />;
            case GameState.SoloSetup: 
              return <SetupScreen onStart={handleStartSolo} onGoHome={handleGoHome} isSolo={true} onBackToDashboard={handleGoHome} />;
            case GameState.TeacherDashboard:
              return currentUser ? <TeacherDashboard 
                  currentUser={currentUser}
                  onCreateNewGame={() => setGameState(GameState.CreateGameSetup)}
                  onViewGame={handleViewGameHistory}
                  onSignOut={handleSignOut}
              /> : <HomeScreen 
                  currentUser={currentUser}
                  onSelectTeacherLogin={handleTeacherLogin}
                  onSelectDashboard={() => setGameState(GameState.TeacherDashboard)}
                  onSelectJoin={() => setGameState(GameState.JoinGameSetup)}
                  onSelectSolo={() => setGameState(GameState.SoloSetup)}
                  onSelectSentenceBuilder={() => setGameState(GameState.SentenceBuilder)}
                  />;
            case GameState.CreateGameSetup:
              return <SetupScreen onStart={handleCreateLobby} onGoHome={handleGoHome} onBackToDashboard={handleGoToDashboard} isSolo={false} isTeacher={!!currentUser} />;
            case GameState.JoinGameSetup:
              return <JoinGameScreen onJoin={handleJoinGame} onGoHome={handleGoHome} />;
            case GameState.Lobby:
              return gameData && <LobbyScreen gameId={gameId} gameData={gameData} playerId={playerId} onStartGame={handleStartGame} />;
            case GameState.InGame:
              if (soloData) {
                  const soloGameWithStartTime = { ...soloData, startTime: new Date() };
                  return <GameScreen gameData={soloGameWithStartTime} playerId={playerId} onTimeUp={handleEndSolo} onGoHome={handleGoHome} onScoreUpdate={() => {}} />;
              }
              if (gameData) {
                  const isHost = playerId === gameData.hostId;
                  if (isHost) {
                      return <HostScreen gameData={gameData} onEndGame={handleForceEndGame} />;
                  }
                  return <GameScreen gameData={gameData} playerId={playerId} onTimeUp={handleEndMultiplayerGame} onGoHome={handleGoHome} onScoreUpdate={handleScoreUpdate} />;
              }
              return null;
            case GameState.Results: 
              if (viewingGameData) {
                  return <HostResultsScreen gameData={viewingGameData} isHistoryView={true} onBackToDashboard={handleGoToDashboard} onNewGame={() => {}} onGoHome={() => {}} />;
              }
              if (scoreAnalysis) {
                  const soloGameData = { prompt: soloData.prompt, players: { [playerId]: { nickname: 'You', story: finalStory, analysis: scoreAnalysis } } };
                  return <ResultsScreen gameData={soloGameData} playerId={playerId} onPlayAgain={handleGoToSoloSetup} onGoHome={handleGoHome} onRetryPrompt={handleRetrySolo} soloHighScore={soloHighScore}/>;
              }
              if (gameData) {
                  const isHost = playerId === gameData.hostId;
                  if (isHost) {
                    return <HostResultsScreen gameData={gameData} onNewGame={() => setGameState(GameState.CreateGameSetup)} onGoHome={handleGoHome} onBackToDashboard={() => {}} />;
                  }
                  return <ResultsScreen gameData={gameData} playerId={playerId} onPlayAgain={() => setGameState(GameState.JoinGameSetup)} onGoHome={handleGoHome} />;
              }
              return null;
            default: 
              return <HomeScreen 
                  currentUser={currentUser}
                  onSelectTeacherLogin={handleTeacherLogin}
                  onSelectDashboard={() => setGameState(GameState.TeacherDashboard)}
                  onSelectJoin={() => setGameState(GameState.JoinGameSetup)}
                  onSelectSolo={() => setGameState(GameState.SoloSetup)}
                  onSelectSentenceBuilder={() => setGameState(GameState.SentenceBuilder)}
                  />;
        }
    };

    return (
        <div className="min-h-screen bg-gradient-to-br from-sky-100 to-emerald-100 p-4 sm:p-6 md:p-8">
            <div className="max-w-7xl mx-auto">
                <header className="text-center mb-8">
                    <div className="flex items-center justify-center gap-3">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className="w-10 h-10 text-sky-600"><path strokeLinecap="round" strokeLinejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 011.13-1.897l8.932-8.931zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0115.75 21H5.25A2.25 2.25 0 013 18.75V8.25A2.25 2.25 0 015.25 6H10" /></svg>
                        <h1 className="text-4xl sm:text-5xl font-bold text-sky-700 tracking-tight">InkXP</h1>
                    </div>
                    <p className="text-slate-600 mt-2 text-lg">Level up your writing experience.</p>
                </header>
                <main className="bg-white/70 backdrop-blur-sm p-6 sm:p-8 rounded-2xl shadow-lg border border-slate-200">{renderContent()}</main>
                <footer className="text-center mt-8 text-sm text-slate-500"><p>(c) Manakouri 2025</p></footer>
            </div>
        </div>
    );
};

const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(<App />);

    </script>
  </body>
</html>